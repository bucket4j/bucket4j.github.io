<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Bucket4j 8.11.0 Reference</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-30W1SHWN4N"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-30W1SHWN4N');
</script>
<!--<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5275939145150040" crossorigin="anonymous"></script>-->
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Bucket4j 8.11.0 Reference</h1>
<div class="details">
<span id="revnumber">version 8.11.0,</span>
<span id="revdate">2024-04-24 05</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#about-bucket4j">1. About Bucket4j</a>
<ul class="sectlevel2">
<li><a href="#what-is-bucket4j">1.1. What is Bucket4j</a></li>
<li><a href="#bucket4j-basic-features">1.2. Bucket4j basic features</a></li>
<li><a href="#bucket4j-distributed-features">1.3. Bucket4j distributed features</a></li>
</ul>
</li>
<li><a href="#basic-functionality">2. Basic functionality</a>
<ul class="sectlevel2">
<li><a href="#concepts">2.1. Concepts</a>
<ul class="sectlevel3">
<li><a href="#bucket">2.1.1. Bucket</a></li>
<li><a href="#bucket-bonfiguration">2.1.2. BucketConfiguration</a></li>
<li><a href="#bandwidth">2.1.3. Limitation/Bandwidth</a></li>
<li><a href="#refill-types">2.1.4. Refill styles</a></li>
<li><a href="#bucket-state">2.1.5. BucketState</a></li>
<li><a href="#local-bucket-builder">2.1.6. BucketBuilder</a></li>
</ul>
</li>
<li><a href="#quick-start-examples">2.2. Quick start examples</a>
<ul class="sectlevel3">
<li><a href="#how-to-dependency-to-bucket4j">2.2.1. How to dependency to Bucket4j</a></li>
<li><a href="#limiting-the-rate-of-access-to-rest-api">2.2.2. Limiting the rate of access to REST API</a></li>
<li><a href="#specifying-initial-amount-of-tokens">2.2.3. Specifying initial amount of tokens</a></li>
<li><a href="#returning-tokens-back-to-bucket">2.2.4. Returning tokens back to bucket</a></li>
<li><a href="#customizing-time-measurement-choosing-nanotime-time-resolution">2.2.5. Customizing time measurement - choosing nanotime time resolution</a></li>
<li><a href="#customizing-time-measurement-specify-custom-time-measurement-strategy">2.2.6. Customizing time measurement -  Specify custom time measurement strategy</a></li>
<li><a href="#blocking-api-example">2.2.7. Blocking API example</a></li>
</ul>
</li>
<li><a href="#listening-for-bucket-events">2.3. Listening for bucket events</a>
<ul class="sectlevel3">
<li><a href="#what-can-be-listened">2.3.1. What can be listened</a></li>
<li><a href="#listener-api-corner-cases">2.3.2. Listener API - corner cases</a></li>
<li><a href="#specify-listener-to-local-bucket-at-build-time">2.3.3. Specify listener to local bucket at build time</a></li>
<li><a href="#specify-listener-to-distributed-bucket-at-build-time">2.3.4. Specify listener to distributed bucket at build time</a></li>
<li><a href="#specify-listener-to-async-distributed-bucket-at-build-time">2.3.5. Specify listener to async distributed bucket at build time</a></li>
<li><a href="#specify-listener-to-distributed-bucket-at-proxy-manager-build-time">2.3.6. Specify listener to distributed bucket at proxy-manager build time</a></li>
<li><a href="#specify-listener-to-bucket-at-use-time">2.3.7. Specify listener to bucket at use time.</a></li>
<li><a href="#example-of-integration-with-dropwizard-metrics-core">2.3.8. Example of integration with Dropwizard metrics-core</a></li>
</ul>
</li>
<li><a href="#verbose-api">2.4. Verbose API</a>
<ul class="sectlevel3">
<li><a href="#verbose-api-entry-points">2.4.1. Verbose API entry-points</a></li>
<li><a href="#principles-of-result-decoration">2.4.2. Principles of result decoration</a></li>
<li><a href="#example-of-verbose-api-usage">2.4.3. Example of Verbose API usage</a></li>
</ul>
</li>
<li><a href="#configuration-replacement">2.5. On-the-fly configuration replacement</a>
<ul class="sectlevel3">
<li><a href="#why-configuration-replacement-is-not-trivial">2.5.1. Why configuration replacement is not trivial?</a></li>
<li><a href="#taking-control-over-replacement-process-via-bandwidth-identifiers">2.5.2. Taking control over replacement process via bandwidth identifiers</a></li>
<li><a href="#tokensinheritancestrategy-explanation">2.5.3. TokensInheritanceStrategy explanation</a></li>
</ul>
</li>
<li><a href="#generic-production-checklist">2.6. Generic production checklist</a>
<ul class="sectlevel3">
<li><a href="#be-wary-of-long-periods">2.6.1. Be wary of long periods</a></li>
<li><a href="#short-timed-bursts">2.6.2. Be wary of short-timed bursts</a></li>
</ul>
</li>
<li><a href="#technical-limitations">2.7. Technical limitations</a>
<ul class="sectlevel3">
<li><a href="#maximum-refill-rate">2.7.1. Maximum refill rate</a></li>
<li><a href="#limitation-for-refill-period">2.7.2. Limitation for refill period</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#distributed-facilities">3. Distributed facilities</a>
<ul class="sectlevel2">
<li><a href="#distributed-checklist">3.1. Production checklist especially in the context of distributed systems</a></li>
<li><a href="#integrations-with-in-memory-grids">3.2. Integrations with in-memory grids</a>
<ul class="sectlevel3">
<li><a href="#bucket4j-jcache">3.2.1. JCache integration</a>
<ul class="sectlevel4">
<li><a href="#example-1-limiting-access-to-http-server-by-ip-address">Example 1 - limiting access to HTTP server by IP address</a></li>
<li><a href="#example-2-limiting-access-to-service-by-contract-agreements">Example 2 - limiting access to service by contract agreements</a></li>
<li><a href="#why-jcache-specification-is-not-enough-in-modern-stacks-and-since-3-0-were-introduced-the-dedicated-modules-for-infinispan-hazelcast-coherence-and-ignite">Why JCache specification is not enough in modern stacks and since 3.0 were introduced the dedicated modules for Infinispan, Hazelcast, Coherence and Ignite?</a></li>
<li><a href="#verification-of-compatibility-with-a-particular-jcache-provider-is-your-responsibility">Verification of compatibility with a particular JCache provider is your responsibility</a></li>
</ul>
</li>
<li><a href="#bucket4j-hazelcast">3.2.2. Hazelcast integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#general-compatibility-matrix-principles">General compatibility matrix principles:</a></li>
<li><a href="#example-of-bucket-instantiation">Example of Bucket instantiation</a></li>
<li><a href="#configuring-flexible-per-entry-expiration">Configuring flexible per entry expiration</a></li>
<li><a href="#configuring-custom-serialization-for-bucket4j-library-classes">Configuring Custom Serialization for Bucket4j library classes</a></li>
<li><a href="#configuring-custom-serialization-using-an-hazelcast-standalone-cluster">Configuring Custom Serialization using an Hazelcast standalone cluster</a></li>
<li><a href="#support-for-externally-managed-hazelcast-without-classpath-access">Support for externally managed Hazelcast without classpath access</a></li>
<li><a href="#known-issues-related-with-docker-andor-springboot">Known issues related with Docker and(or) SpringBoot</a></li>
</ul>
</li>
<li><a href="#bucket4j-ignite">3.2.3. Apache Ignite integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-2">Dependencies</a></li>
<li><a href="#example-of-bucket-instantiation-via-igniteproxymanager">Example of Bucket instantiation via IgniteProxyManager</a></li>
<li><a href="#example-of-bucket-instantiation-via-thin-client">Example of Bucket instantiation via Thin Client</a></li>
<li><a href="#example-of-bucket-instantiation-of-via-thin-client-and-ignitethinclientcasbasedproxymanager">Example of Bucket instantiation of via Thin Client and IgniteThinClientCasBasedProxyManager</a></li>
</ul>
</li>
<li><a href="#bucket4j-infinispan">3.2.4. Infinispan integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-3">Dependencies</a></li>
<li><a href="#general-compatibility-matrix-principles-2">General compatibility matrix principles::</a></li>
<li><a href="#special-notes-for-infinispan-10-0">Special notes for Infinispan 10.0+</a></li>
<li><a href="#example-of-bucket-instantiation-2">Example of Bucket instantiation</a></li>
</ul>
</li>
<li><a href="#bucket4j-coherence">3.2.5. Oracle Coherence integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-4">Dependencies</a></li>
<li><a href="#example-of-bucket-instantiation-3">Example of Bucket instantiation</a></li>
<li><a href="#configuring-pof-serialization-for-bucket4j-library-classes">Configuring POF serialization for Bucket4j library classes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#bucket4j-redis">3.3. Bucket4j-Redis</a>
<ul class="sectlevel3">
<li><a href="#bucket4j-lettuce">3.3.1. Lettuce integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-5">Dependencies</a></li>
<li><a href="#example-of-bucket-instantiation-via-lettucebasedproxymanager">Example of Bucket instantiation via LettuceBasedProxyManager</a></li>
</ul>
</li>
<li><a href="#bucket4j-redisson">3.3.2. Redisson integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-6">Dependencies</a></li>
<li><a href="#example-of-bucket-instantiation-via-redissonbasedproxymanager">Example of Bucket instantiation via RedissonBasedProxyManager</a></li>
</ul>
</li>
<li><a href="#bucket4j-jedis">3.3.3. Jedis integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-7">Dependencies</a></li>
<li><a href="#example-of-bucket-instantiation-via-jedisbasedproxymanager">Example of Bucket instantiation via JedisBasedProxyManager</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jdbc-integrations">3.4. JDBC integrations</a>
<ul class="sectlevel3">
<li><a href="#overriding-table-and-columns-naming-scheme">3.4.1. Overriding table and columns naming scheme</a></li>
<li><a href="#overriding-type-of-primary-key">3.4.2. Overriding type of primary key</a></li>
<li><a href="#bucket4j-postgresql">3.4.3. PostgreSQL integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-8">Dependencies</a></li>
<li><a href="#ddl-example">DDL example</a></li>
<li><a href="#postgresqlselectforupdatebasedproxymanager">PostgreSQLSelectForUpdateBasedProxyManager</a></li>
<li><a href="#postgresqladvisorylockbasedproxymanager">PostgreSQLadvisoryLockBasedProxyManager</a></li>
</ul>
</li>
<li><a href="#bucket4j-mysql">3.4.4. MySQL integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-9">Dependencies</a></li>
<li><a href="#ddl-example-2">DDL example</a></li>
<li><a href="#example-of-bucket-instantiation-4">Example of Bucket instantiation</a></li>
</ul>
</li>
<li><a href="#bucket4j-mariadb">3.4.5. MariaDB integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-10">Dependencies</a></li>
<li><a href="#ddl-example-3">DDL example</a></li>
<li><a href="#example-of-bucket-instantiation-5">Example of Bucket instantiation</a></li>
</ul>
</li>
<li><a href="#bucket4j-oracle">3.4.6. Oracle database integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-11">Dependencies</a></li>
<li><a href="#ddl-example-4">DDL example</a></li>
<li><a href="#example-of-bucket-instantiation-6">Example of Bucket instantiation</a></li>
</ul>
</li>
<li><a href="#bucket4j-mssql">3.4.7. MicrosoftSQLServer integration</a>
<ul class="sectlevel4">
<li><a href="#dependencies-12">Dependencies</a></li>
<li><a href="#ddl-example-5">DDL example</a></li>
<li><a href="#example-of-bucket-instantiation-7">Example of Bucket instantiation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#distributed-facilities-advanced-topics">4. Distributed facilities advanced topics</a>
<ul class="sectlevel2">
<li><a href="#asynchronous-api">4.1. Asynchronous API</a>
<ul class="sectlevel3">
<li><a href="#example-limiting-the-rate-of-access-to-the-asynchronous-servlet">4.1.1. Example - limiting the rate of access to the asynchronous servlet</a></li>
</ul>
</li>
<li><a href="#implicit-configuration-replacement">4.2. Implicit configuration replacement</a></li>
<li><a href="#framework-to-implement-custom-work-with-your-database">4.3. Framework to implement custom work with your database</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="about-bucket4j"><a class="anchor" href="#about-bucket4j"></a>1. About Bucket4j</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what-is-bucket4j"><a class="anchor" href="#what-is-bucket4j"></a>1.1. What is Bucket4j</h3>
<div class="paragraph">
<p>Bucket4j is a Java rate-limiting library that is mainly based on the token-bucket algorithm, which is by the de-facto standard for rate-limiting in the IT industry.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="title">Bucket4j is more than a direct implementation of token-bucket</div>
Its math model provides several useful extensions that are not mentioned in the classic token-bucket interpretations, such as multiple limits per bucket or overdraft. These math extensions will be detailed described later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can read more about the token bucket by following links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket</a> - Wikipedia page describes the token-bucket algorithm in classical form.</p>
</li>
<li>
<p><a href="https://vbukhtoyarov-java.blogspot.com/2021/11/non-formal-overview-of-token-bucket.html">Non-formal overview of token-bucket algorithm</a> - the brief overview of the token-bucket algorithm.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bucket4j-basic-features"><a class="anchor" href="#bucket4j-basic-features"></a>1.2. Bucket4j basic features</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Absolutely non-compromise precision</strong> - Bucket4j does not operate with floats or doubles, all calculations are performed in integer arithmetic, this feature protects end-users from calculation errors involved by rounding.</p>
</li>
<li>
<p><strong>Effective implementation in terms of concurrency</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Bucket4j is good scalable for multi-threading cases it by default uses lock-free implementation.</p>
</li>
<li>
<p>At the same time, the library provides different concurrency strategies that can be chosen when a default lock-free strategy is not desired.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Effective API in terms of garbage collector footprint</strong>: Bucket4j API tries to use primitive types as much as it is possible in order to avoid boxing and other types of floating garbage.</p>
</li>
<li>
<p><strong>Pluggable listener API</strong> that allows implementing monitoring and logging.</p>
</li>
<li>
<p><strong>Rich diagnostic API</strong> that allows investigating internal state.</p>
</li>
<li>
<p><strong>Rich configuration management</strong> - configuration of the bucket can be changed on the fly</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bucket4j-distributed-features"><a class="anchor" href="#bucket4j-distributed-features"></a>1.3. Bucket4j distributed features</h3>
<div class="paragraph">
<p>In addition to the basic features described above, <code>Bucket4j</code> provides the ability to implement rate-limiting in a cluster of JVMs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bucket4j out of the box supports any GRID solution which compatible with JCache API (JSR 107) specification.</p>
</li>
<li>
<p>Bucket4j provides the framework that allows you to quickly build integration with your own persistent technology like RDMS or key-value storage.</p>
</li>
<li>
<p>For clustered usage scenarios Bucket4j supports asynchronous API that extremely matters when going to distribute world because asynchronous API allows avoiding blocking your application threads each time when you need to execute Network request.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basic-functionality"><a class="anchor" href="#basic-functionality"></a>2. Basic functionality</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="concepts"><a class="anchor" href="#concepts"></a>2.1. Concepts</h3>
<div class="sect3">
<h4 id="bucket"><a class="anchor" href="#bucket"></a>2.1.1. Bucket</h4>
<div class="paragraph">
<p><code>Bucket</code> is a rate-limiter that is implemented on the top of ideas of well-known <a href="https://en.wikipedia.org/wiki/Token_bucket">Token Bucket algorithm</a>.
In the Bucket4j library code the <code>Bucket</code> is represented by interface <a href="https://github.com/bucket4j/bucket4j/blob/7.0/bucket4j-core/src/main/java/io/github/bucket4j/Bucket.java">io.github.bucket4j.Bucket</a>.</p>
</div>
<div class="ulist">
<div class="title">Bucket aggregates the following parts:</div>
<ul>
<li>
<p><a href="#bucket-bonfiguration">BucketConfiguration</a> specifies an immutable collection of limitation rules that are used by the bucket during its work.</p>
</li>
<li>
<p><a href="#bucket-state">BucketState</a> the place where bucket stores mutable state like the amount of currently available tokens.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A bucket can be constructed via a special builder API <a href="#local-bucket-builder">BucketBuilder</a> that is available by factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
   .addLimit(...)
   .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket-bonfiguration"><a class="anchor" href="#bucket-bonfiguration"></a>2.1.2. BucketConfiguration</h4>
<div class="paragraph">
<p><code>BucketConfiguration</code> can be described as collection of <a href="#bandwidth">limits</a> that are used by <a href="#bucket">Bucket</a> during its job. Configuration
In the Bucket4j library code the <code>BucketConfiguration</code> is represented by class <a href="https://github.com/bucket4j/bucket4j/blob/7.0/bucket4j-core/src/main/java/io/github/bucket4j/BucketConfiguration.java">io.github.bucket4j.BucketConfiguration</a>. Configuration is immutable, there is no way to add or remove a limit to already created configuration. However, you can replace the configuration of the bucket via creating a new configuration instance and calling <code>bucket.replaceConfiguration(newConfiguration)</code>.</p>
</div>
<div class="paragraph">
<p>Usually, you should not create BucketConfiguration directly(excepting the case with configuration replacement) because <a href="#local-bucket-builder">BucketBuilder</a> does for you behind the scene, for rare cases when you need to create configuration directly you have to use <code>ConfigurationBuilder</code> that is available by factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(...)
    .build()</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Most users configure a single limit per configuration, but it is strongly recommended to analyze whether <a href="#short-timed-bursts">short-timed bursts problem</a>
can affect your application and if so then think about adding more limits.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="bandwidth"><a class="anchor" href="#bandwidth"></a>2.1.3. Limitation/Bandwidth</h4>
<div class="paragraph">
<p>Limitations that are used by bucket can be denoted in terms of bandwidths. Bandwidth is denoted by the following terms:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Capacity</dt>
<dd>
<p><code>Capacity</code> is the term that is directly inherited from the classic interpretation of the token-bucket algorithm, this specifies how many tokens your bucket has. Refill must be configured during building stage
Capacity must be configured during building stage</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit.capacity(42))
    .build()</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Refill</dt>
<dd>
<p>Refill specifies how fast tokens can be refilled after it was consumed from a bucket.
Refill must be configured during building stage</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit.capacity(...).refillXXX(...)) // where XXX - is concrete refill style
    .build()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bucket4j allows to choose different <a href="#refill-types">Refill types</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Initial tokens</dt>
<dd>
<p>Bucket4j extends the token-bucket algorithm by allowing to specify the initial amount of tokens for each bandwidth. By default, an initial amount of tokens equal to capacity and can be changed by <code>withInitialTokens</code> method:<br></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit.capacity(42).refillGreedy(1, ofSeconds(1)).initialTokens(13))
    .build()</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Bandwidth ID</dt>
<dd>
<p>The identifier is the optional attribute that is null by default. You may prefer to assign identifiers for bandwidths if you use on-the-fly configuration replacement and your buckets have more than one bandwidth per bucket, otherwise, it is better to avoid using identifiers to preserve memory.
The Identifier for bandwidth can be specified in following way:<br></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1000).refillGreedy(1000, ofMinutes(1)).id("business-limit"))
    .addLimit(limit -&gt; limit.capacity(100).refillGreedy(100, ofSeconds(1)).id("burst-protection"))
    .build();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Identifiers are critical for on-the-fly configuration replacement functionality because during replacement it needs to decide how correctly propagate information about already consumed tokens from the state before config replacement to the state after replacement. This is not a trivial task especially when the number of limits is changing.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="refill-types"><a class="anchor" href="#refill-types"></a>2.1.4. Refill styles</h4>
<div class="paragraph">
<p>Bucket4j allows to choose different styles in which consumed tokens are being refilled to bucket</p>
</div>
<div class="dlist">
<div class="title">There are four types of refill:</div>
<dl>
<dt class="hdlist1">Greedy</dt>
<dd>
<p>This type of refill greedily regenerates tokens manner, it tries to add the tokens to the bucket as soon as possible. For example refill "10 tokens per 1 second" adds 1 token per every 100 milliseconds, in other words, the refill will not wait 1 second to regenerate a whole bunch of 10 tokens. The three refills below do refill of tokens with the same speed:<br></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket.builder().addLimit(limit -&gt; limit.capacity(1000).refillGreedy(600, ofMinutes(1)))
Bucket.builder().addLimit(limit -&gt; limit.capacity(1000).refillGreedy(10, ofSeconds(1)))
Bucket.builder().addLimit(limit -&gt; limit.capacity(1000).refillGreedy(1, ofMillis(100)))</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Intervally</dt>
<dd>
<p>This type of refill regenerates tokens in an interval manner. "Interval" in opposite to "greedy"  will wait until the whole period will be elapsed before regenerating the whole amount of tokens.<br></p>
<div class="listingblock">
<div class="title">Example:<br></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// refills 100 tokens each minute
Bucket bucket = Bucket.builder().addLimit(limit -&gt; limit.capacity(1000).refillIntervally(100, ofMinutes(1))).build();</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">IntervallyAligned</dt>
<dd>
<p>This type of refill regenerates that does refill of tokens in an interval manner. Interval" in opposite to "greedy"  will wait until the whole period will be elapsed before regenerating the whole amount of tokens. In addition to <strong>Interval</strong> it is possible to specify the time when the first refill should happen.  This type can be used to configure clear interval boundary i.e. start of the second, minute, hour, day.</p>
<div class="listingblock">
<div class="title">Example:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// imagine that wall clock is 16:20, the first refill will happen at 17:00
// first refill will happen in the beginning of next hour
Instant firstRefillTime = ZonedDateTime.now()
  .truncatedTo(ChronoUnit.HOURS)
  .plus(1, ChronoUnit.HOURS)
  .toInstant();

Bucket bucket = Bucket.builder().addLimit(limit -&gt; limit.capacity(400).refillIntervallyAligned(400, ofHours(1), firstRefillTime)).build();</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">RefillIntervallyAlignedWithAdaptiveInitialTokens</dt>
<dd>
<p>See javadocs.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="bucket-state"><a class="anchor" href="#bucket-state"></a>2.1.5. BucketState</h4>
<div class="paragraph">
<p>BucketState is the place where bucket stores own mutable state like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Amount of currently available tokens.</p>
</li>
<li>
<p>Timestamp when the last refill was happen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>BucketState</code> is represented by interface <a href="https://github.com/bucket4j/bucket4j/blob/7.0/bucket4j-core/src/main/java/io/github/bucket4j/Bucket.java">io.github.bucket4j.BucketState</a>. Usually you never interact with this interface, excepting the cases when you want to get access to low-level diagnostic API that is described in</p>
</div>
</div>
<div class="sect3">
<h4 id="local-bucket-builder"><a class="anchor" href="#local-bucket-builder"></a>2.1.6. BucketBuilder</h4>
<div class="paragraph">
<p>It was explicitly decided by library authors to not provide for end-users to construct a library entity via direct constructors.</p>
</div>
<div class="ulist">
<div class="title">It was to reason to split built-time and usage-time APIs:</div>
<ul>
<li>
<p>To be able in the future to change internal implementations without breaking backward compatibility.</p>
</li>
<li>
<p>To to provide <code>Fluent Builder API</code> that in our minds is a good modern library design pattern.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>LocalBucketBuilder</code> is a fluent builder that is specialized to construct the local buckets, where a local bucket is a bucket that holds an internal state just in memory and does not provide clustering functionality. Bellow an example of LocalBucketBuilder usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
    .addLimit(...)
    .withNanosecondPrecision()
    .withSynchronizationStrategy(SynchronizationStrategy.LOCK_FREE)
    .build()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="quick-start-examples"><a class="anchor" href="#quick-start-examples"></a>2.2. Quick start examples</h3>
<div class="sect3">
<h4 id="how-to-dependency-to-bucket4j"><a class="anchor" href="#how-to-dependency-to-bucket4j"></a>2.2.1. How to dependency to Bucket4j</h4>
<div class="paragraph">
<p>The Bucket4j is distributed through <a href="https://mvnrepository.com/artifact/com.bucket4j/bucket4j-core">Maven Central</a>.
You need to add the dependency to your project as described below in order to be able to compile and run examples</p>
</div>
<div class="listingblock">
<div class="title">Maven dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j-core&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gradle dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">implementation 'com.bucket4j:bucket4j-core:8.11.0'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
see <a href="https://github.com/bucket4j/bucket4j/tree/8.0#java-compatibility-matrix">Java compatibility matrix</a> if you need for build that is compatible with Java 8
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="limiting-the-rate-of-access-to-rest-api"><a class="anchor" href="#limiting-the-rate-of-access-to-rest-api"></a>2.2.2. Limiting the rate of access to REST API</h4>
<div class="paragraph">
<p>Imagine that you develop yet another social network and you want to provide REST API for third-party developers.
To protect your system from overloading you want to introduce the following limitation:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The bucket size is 50 calls (which cannot be exceeded at any given time), with a "refill rate" of 10 calls per second that continually increases tokens in the bucket.
In other words. if the client app averages 10 calls per second, it will never be throttled,
and moreover, the client has overdraft equals to 50 calls which can be used if the average is a little bit higher than 10 calls/sec in a short time period.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Constructing the bucket to satisfy the requirements above is a little bit more complicated than for previous examples,
because we have to deal with overdraft, but it is not rocket science:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.github.bucket4j.Bucket;

public class ThrottlingFilter implements javax.servlet.Filter {

    private Bucket createNewBucket() {
         return Bucket.builder()
            .addLimit(limit -&gt; limit.capacity(50).refillGreedy(10, Duration.ofSeconds(1)))
            .build();
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;
        HttpSession session = httpRequest.getSession(true);

        String appKey = SecurityUtils.getThirdPartyAppKey();
        Bucket bucket = (Bucket) session.getAttribute("throttler-" + appKey);
        if (bucket == null) {
            bucket = createNewBucket();
            session.setAttribute("throttler-" + appKey, bucket);
        }

        // tryConsume returns false immediately if no tokens available with the bucket
        if (bucket.tryConsume(1)) {
            // the limit is not exceeded
            filterChain.doFilter(servletRequest, servletResponse);
        } else {
            // limit is exceeded
            HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
            httpResponse.setContentType("text/plain");
            httpResponse.setStatus(429);
            httpResponse.getWriter().append("Too many requests");
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to provide more information to the end-user about the state of the bucket, then the last fragment of code above can be rewritten in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
        ConsumptionProbe probe = bucket.tryConsumeAndReturnRemaining(1);
        if (probe.isConsumed()) {
            // the limit is not exceeded
            httpResponse.setHeader("X-Rate-Limit-Remaining", "" + probe.getRemainingTokens());
            filterChain.doFilter(servletRequest, servletResponse);
        } else {
            // limit is exceeded
            HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
            httpResponse.setStatus(429);
            httpResponse.setHeader("X-Rate-Limit-Retry-After-Seconds", "" + TimeUnit.NANOSECONDS.toSeconds(probe.getNanosToWaitForRefill()));
            httpResponse.setContentType("text/plain");
            httpResponse.getWriter().append("Too many requests");
        }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specifying-initial-amount-of-tokens"><a class="anchor" href="#specifying-initial-amount-of-tokens"></a>2.2.3. Specifying initial amount of tokens</h4>
<div class="paragraph">
<p>By default initial size of the bucket equals capacity.
But sometimes, you may want to have a lesser initial size, for example for the case of cold start in order to prevent denial of service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">int initialTokens = 42;
Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit.capacity(1000).refillGreedy(1000, ofHours(1)).initialTokens(initialTokens))
    .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="returning-tokens-back-to-bucket"><a class="anchor" href="#returning-tokens-back-to-bucket"></a>2.2.4. Returning tokens back to bucket</h4>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Compensating_transaction">compensating transaction</a> is one of the obvious use cases when you want to return tokens back to the bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket wallet;
...
if (wallet.tryConsume(50)) { // get 50 cents from wallet
    try {
        buyCocaCola();
    } catch(NoCocaColaException e) {
        // return money to wallet
        wallet.addTokens(50);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="customizing-time-measurement-choosing-nanotime-time-resolution"><a class="anchor" href="#customizing-time-measurement-choosing-nanotime-time-resolution"></a>2.2.5. Customizing time measurement - choosing nanotime time resolution</h4>
<div class="paragraph">
<p>By default Bucket4j uses millisecond time resolution, it is the preferred time measurement strategy.
But rarely(for example benchmarking) do you wish the nanosecond precision:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket.builder().withNanosecondPrecision()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be very careful to choose this time measurement strategy, because <code>System.nanoTime()</code> produces inaccurate results,
use this strategy only if the period of bandwidth is too small that millisecond resolution will be undesired.</p>
</div>
</div>
<div class="sect3">
<h4 id="customizing-time-measurement-specify-custom-time-measurement-strategy"><a class="anchor" href="#customizing-time-measurement-specify-custom-time-measurement-strategy"></a>2.2.6. Customizing time measurement -  Specify custom time measurement strategy</h4>
<div class="paragraph">
<p>You can specify your custom time meter if existing milliseconds or nanotime time meters are not enough for your purposes.
Imagine that you have a clock, which synchronizes its time with other machines in the current cluster,
if you want to use the time provided by this clock instead of time provided by JVM then you can write something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ClusteredTimeMeter implements TimeMeter {

    @Override
    public long currentTimeNanos() {
        return ClusteredClock.currentTimeMillis() * 1_000_000;
    }

}

Bucket bucket = Bucket.builder()
    .withCustomTimePrecision(new ClusteredTimeMeter())
    .addLimit(limit -&gt; limit.capacity(100).refillGreedy(100, ofMinutes(1)))
    .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="blocking-api-example"><a class="anchor" href="#blocking-api-example"></a>2.2.7. Blocking API example</h4>
<div class="paragraph">
<p>Suppose that you implement consumer of messages from a messaging system and want to process message no fastly then desired rate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// define the bucket with capacity 100  and refill 100 tokens per 1 minute
Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit.capacity(100).refillGreedy(100, ofMinutes(1)))
    .build();

// do polling in infinite loop
while (true) {
    List&lt;Message&gt; messages = consumer.poll();
    for (Message message : messages) {
        // Consume a token from the token bucket. If a token is not available this method will block until the refill adds one to the bucket.
        bucket.asBlocking().consume(1);
        process(message);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="listening-for-bucket-events"><a class="anchor" href="#listening-for-bucket-events"></a>2.3. Listening for bucket events</h3>
<div class="sect3">
<h4 id="what-can-be-listened"><a class="anchor" href="#what-can-be-listened"></a>2.3.1. What can be listened</h4>
<div class="ulist">
<div class="title">You can attach a listener to bucket by to track following events:</div>
<ul>
<li>
<p>When tokens are consumed from a bucket.</p>
</li>
<li>
<p>When consumption requests were rejected by the bucket.</p>
</li>
<li>
<p>When the thread was parked to wait for tokens refill as a result of interaction with <code>BlockingBucket</code>.</p>
</li>
<li>
<p>When the thread was interrupted during the wait for tokens to be refilled as a result of interaction with <code>BlockingBucket</code>.</p>
</li>
<li>
<p>When a delayed task was submitted to <code>ScheduledExecutorService</code> as a result of interaction with <code>AsyncScheduledBucket</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="listener-api-corner-cases"><a class="anchor" href="#listener-api-corner-cases"></a>2.3.2. Listener API - corner cases</h4>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Question:</strong> How many listeners are needed to create an application that uses many buckets?</p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong>  it depends:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to have aggregated statistics for all buckets then create a single listener per application and reuse this listener for all buckets.</p>
</li>
<li>
<p>If you want to measure statistics independently per bucket then use a listener per bucket model.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Question:</strong> where are methods the listener is invoking in case of distributed usage?</p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong> listener always invoked on the client-side, which means that each client JVM will have its independent stat for the same bucket.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Question:</strong> Why does bucket invoke the listener on the client-side instead of the server-side in case of distributed scenario? What do I need to do if I need an aggregated stat across the whole cluster?</p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong> Because of a planned expansion to non-JVM back-ends such as Redis, MySQL, PostgreSQL.
It is not possible to serialize and invoke listener on this non-java back-ends, so it was decided to invoke listener on the client-side,
to avoid inconsistency between different back-ends in the future.
You can do post-aggregation of monitoring statistics via features built into your monitoring database or via mediator(like StatsD) between your application and the monitoring database.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specify-listener-to-local-bucket-at-build-time"><a class="anchor" href="#specify-listener-to-local-bucket-at-build-time"></a>2.3.3. Specify listener to local bucket at build time</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketListener listener = new MyListener();

Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit,capacity(100).refillGreedy(100, ofMinutes(1)))
    .withListener(listener)
    .build()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specify-listener-to-distributed-bucket-at-build-time"><a class="anchor" href="#specify-listener-to-distributed-bucket-at-build-time"></a>2.3.4. Specify listener to distributed bucket at build time</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketListener listener = new MyListener();

Bucket bucket = proxyManager.builder()
     .withListener(listener)
     .build(key, configSupplier);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specify-listener-to-async-distributed-bucket-at-build-time"><a class="anchor" href="#specify-listener-to-async-distributed-bucket-at-build-time"></a>2.3.5. Specify listener to async distributed bucket at build time</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketListener listener = new MyListener();

AsyncBucketProxy bucket = proxyManager.asAsync().builder()
     .withListener(listener)
     .build(key, configSupplier);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specify-listener-to-distributed-bucket-at-proxy-manager-build-time"><a class="anchor" href="#specify-listener-to-distributed-bucket-at-proxy-manager-build-time"></a>2.3.6. Specify listener to distributed bucket at proxy-manager build time</h4>
<div class="paragraph">
<p>You can configure default listener at proxy-manager build time. And this listener will be used for all bucket that belong to this proxy-manager.
Bellow example for Hazelcast, the way to configure listener for other backends is the same.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketListener listener = new MyListener();

// listener will be attached to all buckets that belong to this proxy manager
HazelcastLockBasedProxyManager proxyManager = Bucket4jHazelcast.entryProcessorBasedBuilder(map)
    .defaultListener(listener)
    .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specify-listener-to-bucket-at-use-time"><a class="anchor" href="#specify-listener-to-bucket-at-use-time"></a>2.3.7. Specify listener to bucket at use time.</h4>
<div class="paragraph">
<p>Sometimes listener is not known at bucket build time, and you want to clarify listener later.
For example it can happen when you want to share same bucket per multiple users,
but in same time it needs to have dedicated listener per each user.</p>
</div>
<div class="paragraph">
<p>In such case you can build bucket without listener and attach it later via the <code>toListenable</code> method,
this way will create a decorator to original bucket</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void doSomethingProtected(User user, Bucket bucket) {
    bucket = decorate(user, bucket).tryConsume(1)
    if (bucket.tryConsume(1)) {
        doSomething(user);
    } else {
        handleRateLimitError(user);
    }
}

...
private Bucket decorate(User user, Bucket originalbucket) {
    BucketListener listener = new BucketListener() {
        @Override
        public void onConsumed(long tokens) {
            // log something related for user or increase user related metrics
        }
        @Override
        public void onRejected(long tokens) {
            // log something related for user or increase user related metrics
        }
        ...
    }
    return originalbucket.toListenable(listener);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-of-integration-with-dropwizard-metrics-core"><a class="anchor" href="#example-of-integration-with-dropwizard-metrics-core"></a>2.3.8. Example of integration with Dropwizard metrics-core</h4>
<div class="paragraph">
<p><code>io.github.bucket4j.SimpleBucketListener</code> is a simple implementation of <code>io.github.bucket4j.BucketListener</code> interface that is available out of the box. Below is the example of exposing statistics via Dropwizard Metrics(for Micrometer it should be quite similar):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static Bucket decorateBucketByStatListener(Bucket originalBucket, String bucketName, MetricRegistry registry) {
  SimpleBucketListener stat = new SimpleBucketListener();
  registry.register(name + ".consumed", (Gauge&lt;Long&gt;) stat::getConsumed);
  registry.register(name + ".rejected", (Gauge&lt;Long&gt;) stat::getRejected);
  registry.register(name + ".parkedNanos", (Gauge&lt;Long&gt;) stat::getParkedNanos);
  registry.register(name + ".interrupted", (Gauge&lt;Long&gt;) stat::getInterrupted);
  registry.register(name + ".delayedNanos", (Gauge&lt;Long&gt;) stat::getDelayedNanos);

  return originalBucket.toListenable(stat);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="verbose-api"><a class="anchor" href="#verbose-api"></a>2.4. Verbose API</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Verbose API</dt>
<dd>
<p>is the API whose intent is in injecting low-level diagnostic information into the results of any interaction with a bucket. Verbose API provides the same functionality as Regular API, with one exception - a result of any method always decorated by <code>VerboseResult</code> wrapper.</p>
</dd>
<dt class="hdlist1">VerboseResult</dt>
<dd>
<p>is the wrapper for interaction result that provides the snapshot of a bucket and its configuration that was actual at the moment of interaction with a bucket.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="verbose-api-entry-points"><a class="anchor" href="#verbose-api-entry-points"></a>2.4.1. Verbose API entry-points</h4>
<div class="paragraph">
<p>The way to get access for <code>Verbose API</code> is the same for all types of buckets, just call <code>asVerbose()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// for io.github.bucket4j.Bucket
Bucket bucket = ...;
bucket.asVerbose();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// for io.github.bucket4j.Bucket
Bucket bucket = ...;
VerboseBucket verboseBucket = bucket.asVerbose();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// for io.github.bucket4j.distributed.BucketProxy
BucketProxy bucket = ...;
VerboseBucket verboseBucket = bucket.asVerbose();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// for io.github.bucket4j.distributed.AsyncBucketProxy
AsyncBucketProxy bucket = ...;
AsyncVerboseBucket verboseBucket = bucket.asVerbose();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
BlockingBucket and ScheduledBucket do not provide the verbose analogs. VerboseResult has no sense for this kind of buckets because interactions with them can be followed by thread sleep or delayed execution, so VerboseResult can be stale and irrelevant to the moment when control over execution is being returned to your code.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="principles-of-result-decoration"><a class="anchor" href="#principles-of-result-decoration"></a>2.4.2. Principles of result decoration</h4>
<div class="ulist">
<ul>
<li>
<p>void return type always decorated by <code>VerboseResult&lt;Void&gt;</code></p>
</li>
<li>
<p>A primitive result type like long, boolean always decorated by correspondent boxed type for example <code>VerboseResult&lt;Boolean&gt;</code></p>
</li>
<li>
<p>Non-primitive result type always decorated as is, for example, <code>VerboseResult&lt;EstimationProbe&gt;</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="example-of-verbose-api-usage"><a class="anchor" href="#example-of-verbose-api-usage"></a>2.4.3. Example of Verbose API usage</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">VerboseResult&lt;ConsumptionProbe&gt; verboseResult = bucket.asVerbose().tryConsumeAndReturnRemaining(numberOfTokens);

BucketConfiguration bucketConfiguration = verboseResult.getConfiguration();
long capacity = Arrays.stream(bucketConfiguration.getBandwidths())
                .mapToLong(Bandwidth::getCapacity)
                .max().getAsLong();
response.addHeader("RateLimit-Limit", "" + capacity));

VerboseResult.Diagnostics diagnostics = verboseResult.getDiagnostics()
response.addHeader("RateLimit-Remaining", "" + diagnostics.getAvailableTokens());
response.addHeader("RateLimit-Reset", "" + TimeUnit.NANOSECONDS.toSeconds(diagnostics.calculateFullRefillingTime()));

ConsumptionProbe probe = verboseResult.getValue();
if (probe.isConsumed()) {
    // the limit is not exceeded
    filterChain.doFilter(servletRequest, servletResponse);
} else {
    // limit is exceeded
    HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
    httpResponse.setStatus(429);
    httpResponse.setContentType("text/plain");
    httpResponse.getWriter().append("Too many requests");
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-replacement"><a class="anchor" href="#configuration-replacement"></a>2.5. On-the-fly configuration replacement</h3>
<div class="paragraph">
<p>As previously mentioned in the definition for <a href="#bucket-bonfiguration">BucketConfiguration</a> it is an immutable object.
It is not possible to add, remove or change the limits for already created configuration, however, you can replace the configuration of the bucket via creating a new configuration instance and calling <code>bucket.replaceConfiguration(newConfiguration, tokensInheritanceStrategy)</code>.</p>
</div>
<div class="sect3">
<h4 id="why-configuration-replacement-is-not-trivial"><a class="anchor" href="#why-configuration-replacement-is-not-trivial"></a>2.5.1. Why configuration replacement is not trivial?</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first problem of configuration replacement is deciding on how to propagate available tokens from a bucket with a previous configuration to the bucket with a new configuration. If you don&#8217;t care about previous the bucket state then use <a href="#tokens-inheritance-strategy-reset">TokensInheritanceStrategy.RESET</a>. But it becomes a tricky problem when we expect that previous consumption (that has not been compensated by refill yet) should take effect on the bucket with a new configuration. In this case, you need to choose between:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#tokens-inheritance-strategy-proportionally">TokensInheritanceStrategy.PROPORTIONALLY</a></p>
</li>
<li>
<p><a href="#tokens-inheritance-strategy-as-is">TokensInheritanceStrategy.AS_IS</a></p>
</li>
<li>
<p><a href="#tokens-inheritance-strategy-additive">TokensInheritanceStrategy.ADDITIVE</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>There is another problem when you are choosing <a href="#tokens-inheritance-strategy-proportionally">PROPORTIONALLY</a>, <a href="#tokens-inheritance-strategy-as-is">AS_IS</a> or <a href="#tokens-inheritance-strategy-additive">ADDITIVE</a> or <a href="#tokens-inheritance-strategy-as-is">AS_IS</a>  and a bucket has more than one bandwidth. For example, how does replaceConfiguration implementation bind bandwidths to each other in the following example?</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
    .addLimit(limit -&gt; limit.capacity(10000).refillGreedy(10000, ofHours(1)))
    .build();
    ...
BucketConfiguration newConfiguration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(5000).refillGreedy(5000, ofHours(1)))
    .addLimit(limit -&gt; limit.capacity(100).refillGreedy(100, ofSeconds(10)))
    .build();
bucket.replaceConfiguration(newConfiguration, TokensInheritanceStrategy.AS_IS);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is obvious that a simple strategy - copying tokens by bandwidth index will not work well in this case, because it highly depends on the order in which bandwidths were mentioned in the new and previous configuration.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="taking-control-over-replacement-process-via-bandwidth-identifiers"><a class="anchor" href="#taking-control-over-replacement-process-via-bandwidth-identifiers"></a>2.5.2. Taking control over replacement process via bandwidth identifiers</h4>
<div class="paragraph">
<p>Instead of inventing the backward magic Bucket4j provides you the ability to keep control this process by specifying identifiers for bandwidth,
so in case of multiple bandwidth configuration replacement codes can copy available tokens by bandwidth ID. So it is better to rewrite the code above as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    Bucket bucket = Bucket.builder()
         .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)).id("technical-limit"))
         .addLimit(limit -&gt; limit.capacity(10000).refillGreedy(10000, ofHours(1)).id("business-limit"))
         .build();
     ...
     BucketConfiguration newConfiguration = BucketConfiguration.builder()
         .addLimit(limit -&gt; limit.capacity(100).refillGreedy(100, ofSeconds(10)).id("technical-limit"))
         .addLimit(limit -&gt; limit.capacity(5000).refillGreedy(5000, ofHours(1)).id("business-limit"))
         .build();
     bucket.replaceConfiguration(newConfiguration, TokensInheritanceStrategy.PROPORTIONALLY);</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">There are the following rules for bandwidth identifiers:</div>
<ul>
<li>
<p>By default bandwidth has &lt;b&gt;null&lt;/b&gt; identifier.</p>
</li>
<li>
<p>null value of identifier equals to another null value if and only if there is only one bandwidth with a null identifier.</p>
</li>
<li>
<p>If an identifier for bandwidth is specified then it must be unique in the bucket. Bucket does not allow to create of several bandwidths with the same ID.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="tokensinheritancestrategy-explanation"><a class="anchor" href="#tokensinheritancestrategy-explanation"></a>2.5.3. TokensInheritanceStrategy explanation</h4>
<div class="paragraph">
<p><strong>TokensInheritanceStrategy</strong> specifies the rules for inheritance of available tokens during configuration replacement process.</p>
</div>
<div id="tokens-inheritance-strategy-reset" class="dlist">
<div class="title">There are four strategies:</div>
<dl>
<dt class="hdlist1">RESET</dt>
<dd>
<p>Use this mode when you want just to forget about the previous bucket state. RESET just instructs to erase all previous states. Using this strategy equals removing a bucket and creating again with a new configuration.</p>
</dd>
</dl>
</div>
<div id="tokens-inheritance-strategy-proportionally" class="dlist">
<dl>
<dt class="hdlist1">PROPORTIONALLY</dt>
<dd>
<p>Makes to copy available tokens proportional to bandwidth capacity by following formula: <strong>newAvailableTokens = availableTokensBeforeReplacement * (newBandwidthCapacity / capacityBeforeReplacement)</strong></p>
<div class="ulist">
<div class="title">PROPORTIONALLY strategy examples:</div>
<ul>
<li>
<p><strong>Example 1:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.<br></p>
<div class="paragraph">
<p>At the moment of config replacement, there were 40 available tokens.<br></p>
</div>
<div class="paragraph">
<p>After replacing this bandwidth by following <code>Bandwidth.builder().capacity(200).refillGreedy(10, ofMinutes(1)).build()</code> 40 available tokens will be multiplied by 2(200/100), and after replacement, we will have 80 available tokens.</p>
</div>
</li>
<li>
<p><strong>Example 2:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.
At the moment of config replacement, there were 40 available tokens. After replacing this bandwidth by following <code>Bandwidth.builder().capacity(20).refillGreedy(10, ofMinutes(1)).build()</code> 40 available tokens will be multiplied by 0.2(20/100), and after replacement, we will have 8 available tokens.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="tokens-inheritance-strategy-as-is" class="dlist">
<dl>
<dt class="hdlist1">AS_IS</dt>
<dd>
<p>Instructs to copy available tokens as is, but with one exclusion: if available tokens are greater than new capacity, available tokens will be decreased to new capacity.</p>
<div class="ulist">
<div class="title">AS_IS strategy examples:</div>
<ul>
<li>
<p><strong>Example 1:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.<br></p>
<div class="paragraph">
<p>At the moment of config replacement, it was 40 available tokens.<br></p>
</div>
<div class="paragraph">
<p>After replacing this bandwidth by following <code>Bandwidth.builder().capacity(200).refillGreedy(10, ofMinutes(1)).build()</code> 40 available tokens will be just copied, and after replacement, we will have 40 available tokens.</p>
</div>
</li>
<li>
<p><strong>Example 2:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.<br></p>
<div class="paragraph">
<p>At the moment of config replacement, it was 40 available tokens.<br></p>
</div>
<div class="paragraph">
<p>After replacing this bandwidth by following <code>Bandwidth.builder().capacity(20).refillGreedy(10, ofMinutes(1)).build()</code> 40 available tokens can not be copied as is because it is greater than new capacity, so available tokens will be reduced to 20.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="tokens-inheritance-strategy-additive" class="dlist">
<dl>
<dt class="hdlist1">ADDITIVE</dt>
<dd>
<p>Instructs to copy available tokens as is, but with one exclusion: if new bandwidth capacity is greater than old capacity, available tokens will be increased by the difference between the old and the new configuration.<br></p>
<div class="paragraph">
<p><strong>The formula is following:</strong><br>
<code>newAvailableTokens = Math.min(availableTokensBeforeReplacement, newBandwidthCapacity) + Math.max(0, newBandwidthCapacity - capacityBeforeReplacement)</code><br></p>
</div>
<div class="ulist">
<div class="title">ADDITIVE strategy examples:</div>
<ul>
<li>
<p><strong>Example 1:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.<br></p>
<div class="paragraph">
<p>At the moment of configuration replacement, it was 40 available tokens.<br></p>
</div>
<div class="paragraph">
<p>After replacing this bandwidth by following <code>Bandwidth.builder().capacity(200).refillGreedy(200, ofMinutes(1)).build()</code> 40 available tokens will be copied and added to the difference between old and new configurations, and after replacement, we will have 140 available tokens.</p>
</div>
</li>
<li>
<p><strong>Example 2:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.<br></p>
<div class="paragraph">
<p>At the moment of config replacement, it was 40 available tokens.<br></p>
</div>
<div class="paragraph">
<p>After replacing this bandwidth by following <code>Bandwidth.builder().capacity(20).refillGreedy(10, ofMinutes(1)).build()</code>,
and after replacement we will have 20 available tokens.</p>
</div>
</li>
<li>
<p><strong>Example 3:</strong> imagine bandwidth that was created by <code>Bandwidth.builder().capacity(100).refillGreedy(10, ofMinutes(1)).build()</code>.<br></p>
<div class="paragraph">
<p>At the moment of config replacement, it was 10 available tokens.</p>
</div>
<div class="paragraph">
<p>After replacing this bandwidth by following <code>Bandwidth.builder().capacity(100).refillGreedy(20, ofMinutes(1)).build()</code>, and after replacement, we will have 10 available tokens.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generic-production-checklist"><a class="anchor" href="#generic-production-checklist"></a>2.6. Generic production checklist</h3>
<div class="paragraph">
<p>The considerations described below apply to each solution based on the token-bucket or leaky-bucket algorithm.
You need to understand, agree, and configure the following points:</p>
</div>
<div class="sect3">
<h4 id="be-wary-of-long-periods"><a class="anchor" href="#be-wary-of-long-periods"></a>2.6.1. Be wary of long periods</h4>
<div class="paragraph">
<p>When you are planning to use any solution based on token-bucket for throttling incoming requests,
you need to pay close attention to the throttling time window.</p>
</div>
<div class="ulist">
<div class="title">Example of a dangerous configuration:</div>
<ul>
<li>
<p>Given a bucket with a limit of 10000 tokens/ per 1 hour per user.</p>
</li>
<li>
<p>A malicious attacker may send 9999 requests in a very short period, for example within 10 seconds. This would correspond to 100 requests per second which could seriously impact your system.</p>
</li>
<li>
<p>A skilled attacker could stop at 9999 requests per hour, and repeat every hour, which would make this attack impossible to detect (because the limit would not be reached).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To protect from this kind of attack, you should specify multiple limits like bellow</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bucket bucket = Bucket.builder()
    .addLimit(limit -&gt; capacity(10_000).refillGreedy(10_000, ofHours(1)))
    .addLimit(limit -&gt; capacity(20).refillGreedy(20, ofSeconds(1))) // attacker is unable to achieve 1000RPS and crash service in short time</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number of limits specified per bucket does not impact the performance.</p>
</div>
</div>
<div class="sect3">
<h4 id="short-timed-bursts"><a class="anchor" href="#short-timed-bursts"></a>2.6.2. Be wary of short-timed bursts</h4>
<div class="paragraph">
<p>The token bucket is an efficient algorithm with a low and fixed memory footprint, independently of the incoming request rate (it can be millions per second) the bucket consumes no more than 40 bytes(five longs).
But an efficient memory footprint has its own cost - bandwidth limitation is only satisfied over a long period. In other words, you cannot avoid short-timed bursts.</p>
</div>
<div class="ulist">
<div class="title">Let us describe an example of a local burst:</div>
<ul>
<li>
<p>Given a bucket with a limit of 100 tokens/min. We start with a full bucket, i.e. with 100 tokens.</p>
</li>
<li>
<p>At <code>T1</code> 100 requests are made and thus the bucket becomes empty.</p>
</li>
<li>
<p>At <code>T1+1min</code> the bucket is full again because tokens are fully regenerated and we can immediately consume 100 tokens.</p>
</li>
<li>
<p>This means that between  <code>T1</code> and <code>T1+1min</code> we have consumed 200 tokens. Over a long time, there will be no more than 100 requests per min, but as shown above, it is possible to burst at <strong>twice the limit</strong> here at 100 tokens per min.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">These bursts are inherent to token bucket algorithms and cannot be avoided. If short-timed bursts are unacceptable you then have three options:</div>
<ul>
<li>
<p>Do not use Bucket4j or any other solution implemented on top of token-bucket algorithms, because token-bucket is specially designed for network traffic management devices for which short-living traffic spike is a regular case, trying to avoid spike at all contradicts with the nature of token-bucket.</p>
</li>
<li>
<p>Since the value of burst always equals capacity, try to reduce the capacity and speed of refill. For example, if you have <strong><strong>strong</strong></strong> requirements <code>100tokens/60seconds</code> then configure bucket as <code>capacity=50tokens  refill=50tokens/60seconds</code>. It is worth mentioning that this way leads to the following drawbacks:&#8201;&#8212;&#8201;In one time you are not allowed to consume several tokens greater than capacity, according to the example above - before capacity reducing you were able to consume 100 tokens in a single request, after reducing you can consume 50 tokens in one request at max.&#8201;&#8212;&#8201;Reducing the speed of refill leads to underconsumption on long term periods, it is obvious that with refill <code>50tokens/60seconds</code> you will be able to consume 3050 tokens for 1 hour, instead of 6100(as was prior refill reducing).&#8201;&#8212;&#8201;As a summary of the two drawbacks above, we can say that you will pay via <strong>underconsumption</strong> for eliminating the risk of <strong>overconsumption</strong>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="technical-limitations"><a class="anchor" href="#technical-limitations"></a>2.7. Technical limitations</h3>
<div class="paragraph">
<p>To provide the best precision, Bucket4j uses integer arithmetic as much as possible, so any internal calculation is limited by bound <code>Long.MAX_VALUE</code>. The library introduces several limits that are described further, to be sure that calculations will never exceed the bound.</p>
</div>
<div class="sect3">
<h4 id="maximum-refill-rate"><a class="anchor" href="#maximum-refill-rate"></a>2.7.1. Maximum refill rate</h4>
<div class="paragraph">
<p>The maximum refill rate is limited by <code>1 token/ 1 nanosecond</code>. Following examples of API usage will raise exceptions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bandwidth.builder().capacity(100).refillGreedy(2, ofNanos(1));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bandwidth.builder().capacity(10_000).refillGreedy(1_001, ofNanos(1_000));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bandwidth.builder().capacity(1_000_000).refillGreedy(1_000_001, ofMillis(1));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="limitation-for-refill-period"><a class="anchor" href="#limitation-for-refill-period"></a>2.7.2. Limitation for refill period</h4>
<div class="paragraph">
<p>Bucket4j works with time intervals as the 64-bit number of nanoseconds. So maximum refill period that is possible will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Duration.ofNanos(Long.MAX_VALUE);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any attempt to specify a period longer than the limit above will fail with an exception. For example, the code below will failed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Bandwidth.builder(limit -&gt; limit.capacity(...).refillGreedy(42, Duration.ofMinutes(153722867280912930));

Exception in thread "main" java.lang.ArithmeticException: long overflow
   at java.lang.Math.multiplyExact(Math.java:892)
   at java.time.Duration.toNanos(Duration.java:1186)
   ...</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="distributed-facilities"><a class="anchor" href="#distributed-facilities"></a>3. Distributed facilities</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="distributed-checklist"><a class="anchor" href="#distributed-checklist"></a>3.1. Production checklist especially in the context of distributed systems</h3>
<div class="paragraph">
<p>Before using Bucket4j in clustered scenario you need to understand, agree, and configure the following points:</p>
</div>
<div class="paragraph">
<div class="title">Do not forget about exception handling</div>
<p>When working within a distributed system, it is inevitable that requests may cross the border of the current JVM, leading to communication on the network.
The network being unreliable, it is impossible to avoid failures. Thus you should embrace this reality and be ready to get unchecked exceptions when interacting with a distributed bucket.
<strong>It is your responsibility to handle(or ignore) such exceptions:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>You probably do not want to fail business transactions if the grid responsible for throttling goes down. If this is the case you can simply log the exception and continue your business transaction without throttling</p>
</li>
<li>
<p>If you wish to fail your business transaction when the grid responsible for throttling goes down, simply rethrow or don&#8217;t catch the exception</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Do not forget to configure backups</div>
<p>If the state of any bucket should survive the restart/crash of the grid node that holds its state, you need to configure backups yourself, in a way specific to the particular grid vendor. For example, see how to <a href="https://apacheignite.readme.io/v2.3/docs/primary-and-backup-copies">configure backups for Apache Ignite</a>.</p>
</div>
<div class="paragraph">
<div class="title">Retention tuning is your responsibility</div>
<p>When dealing with multi-tenant scenarios like a bucket per user or a bucket per IP address,
the number of buckets in the cache will continuously increase. This is because a new bucket will be created each time a new key is detected.
To prevent exhausting the available memory of your cluster you need to configure the following aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Expiration since last access</strong> - in order to allow the grid to remove the keys which haven&#8217;t been used in a long time. For example, see how to <a href="https://apacheignite.readme.io/docs/expiry-policies">configure expiration policy for Apache Ignite</a>.</p>
</li>
<li>
<p><strong>Maximum cache size(in units of bytes)</strong> - Obviously it is preferable to lose bucket data than lose the whole cluster due to memory exception.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">High availability(HA) tuning and testing is your responsibility</div>
<p>There are no special settings for HA supported by Bucket4j because Bucket4j does nothing more than just invoking EntryProcessors on the cache.
Instead, Bucket4j relies on <strong>you</strong> to configure the cache with proper parameters that control redundancy and high availability.</p>
</div>
<div class="paragraph">
<p>Years of experience working with the distributed system has taught the author that High Availability does not come for free. You need to test and verify that your system remains available. This cannot be provided by this or any other library. Your system will most certainly go down if you do not plan for that.</p>
</div>
</div>
<div class="sect2">
<h3 id="integrations-with-in-memory-grids"><a class="anchor" href="#integrations-with-in-memory-grids"></a>3.2. Integrations with in-memory grids</h3>
<div class="sect3">
<h4 id="bucket4j-jcache"><a class="anchor" href="#bucket4j-jcache"></a>3.2.1. JCache integration</h4>
<div class="paragraph">
<p><code>Bucket4j</code> supports any GRID solution which compatible with <a href="https://www.jcp.org/en/jsr/detail?id=107">JCache API (JSR 107)</a> specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Do not forget to read <a href="#distributed-checklist">Distributed usage checklist</a>  before using the Bucket4j over the JCache cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use the JCache extension you also need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-jcache&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-jcache&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JCache expects javax.cache.cache-api to be a provided dependency. Do not forget to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;javax.cache&lt;/groupId&gt;
    &lt;artifactId&gt;cache-api&lt;/artifactId&gt;
    &lt;version&gt;${jcache.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="example-1-limiting-access-to-http-server-by-ip-address"><a class="anchor" href="#example-1-limiting-access-to-http-server-by-ip-address"></a>Example 1 - limiting access to HTTP server by IP address</h5>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Imagine that you develop any Servlet-based WEB application and want to limit access per IP basis.
You want to use the same limits for each IP - 30 requests per minute.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>ServletFilter would be the obvious place to check limits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class IpThrottlingFilter implements javax.servlet.Filter {

    private static final BucketConfiguration configuration = BucketConfiguration.builder()
          .addLimit(limit -&gt; limit.capacity(30).refillGreedy(30, ofMinutes(1)))
          .build();

    // cache for storing token buckets, where IP is key.
    @Inject
    private javax.cache.Cache&lt;String, byte[]&gt; cache;

    private ProxyManager&lt;String&gt; buckets;

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
         // init bucket registry
         buckets = Bucket4jJCache
            .entryProcessorBasedBuilder(cache)
             // setup optional parameters if necessary
            .build();
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;
        String ip = IpHelper.getIpFromRequest(httpRequest);

        // acquire cheap proxy to the bucket
        Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);

        // tryConsume returns false immediately if no tokens available with the bucket
        if (bucket.tryConsume(1)) {
            // the limit is not exceeded
            filterChain.doFilter(servletRequest, servletResponse);
        } else {
            // limit is exceeded
            HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
            httpResponse.setContentType("text/plain");
            httpResponse.setStatus(429);
            httpResponse.getWriter().append("Too many requests");
        }
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-2-limiting-access-to-service-by-contract-agreements"><a class="anchor" href="#example-2-limiting-access-to-service-by-contract-agreements"></a>Example 2 - limiting access to service by contract agreements</h5>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Imagine that you provide paid language translation service via HTTP. Each user has a unique agreement that differs from the other.
Details of each agreement are stored in a relational database and take significant time to fetch(for example 100ms).
The example above will not work fine in this case, because time to create/fetch the configuration of the bucket from the database
will be 100 times slower than limit-checking itself.
Bucket4j solves this problem via lazy configuration suppliers which are called if and only if the bucket was not yet stored in the grid,
thus it is possible to implement a solution that will read the agreement from the database once per user.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class IpThrottlingFilter implements javax.servlet.Filter {

    // service to provide per user limits
    @Inject
    private LimitProvider limitProvider;

    // cache for storing token buckets, where IP is key.
    @Inject
    private javax.cache.Cache&lt;String, byte[]&gt; cache;

    private ProxyManager&lt;String&gt; buckets;

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
         // init bucket registry
         buckets = Bucket4jJCache
            .entryProcessorBasedBuilder(cache)
             // setup optional parameters if necessary
            .build();
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;
        String userId = AutentificationHelper.getUserIdFromRequest(httpRequest);

        // prepare configuration supplier which will be called(on the first interaction with proxy) if the bucket was not saved yet previously.
        Supplier&lt;BucketConfiguration&gt; configurationLazySupplier = getConfigSupplierForUser(userId);

        // acquire cheap proxy to the bucket
        Bucket bucket = proxyManager.getProxy(key, configurationLazySupplier);

        // tryConsume returns false immediately if no tokens available with the bucket
        if (bucket.tryConsume(1)) {
            // the limit is not exceeded
            filterChain.doFilter(servletRequest, servletResponse);
        } else {
            // limit is exceeded
            HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
            httpResponse.setContentType("text/plain");
            httpResponse.setStatus(429);
            httpResponse.getWriter().append("Too many requests");
        }
    }

    private Supplier&lt;BucketConfiguration&gt; getConfigSupplierForUser(String userId) {
         return () -&gt; {
             long translationsPerDay = limitProvider.readPerDayLimitFromAgreementsDatabase(userId);
             return BucketConfiguratiion.builder()
                    .addLimit(limit -&gt; limit.capacity(translationsPerDay).refillGreedy(1_000, ofDays(1)))
                     .build();
         };
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="why-jcache-specification-is-not-enough-in-modern-stacks-and-since-3-0-were-introduced-the-dedicated-modules-for-infinispan-hazelcast-coherence-and-ignite"><a class="anchor" href="#why-jcache-specification-is-not-enough-in-modern-stacks-and-since-3-0-were-introduced-the-dedicated-modules-for-infinispan-hazelcast-coherence-and-ignite"></a>Why JCache specification is not enough in modern stacks and since 3.0 were introduced the dedicated modules for Infinispan, Hazelcast, Coherence and Ignite?</h5>
<div class="paragraph">
<p>Asynchronous processing is very important for high-throughput applications, but JCache specification does not specify asynchronous API, because two early attempts to bring this kind of functionality at spec level <a href="https://github.com/jsr107/jsr107spec/issues/307">307</a>, <a href="https://github.com/jsr107/jsr107spec/issues/312">312</a> were failed in absence of consensus.</p>
</div>
<div class="ulist">
<div class="title">Sad, but true, if you need for asynchronous API, then JCache extension is useless, and you need to choose from following extensions:</div>
<ul>
<li>
<p><a href="#bucket4j-ignite">bucket4j-ignite</a></p>
</li>
<li>
<p><a href="#bucket4j-hazelcast">bucket4j-hazelcast</a></p>
</li>
<li>
<p><a href="#bucket4j-infinispan">bucket4j-infinispan</a></p>
</li>
<li>
<p><a href="#bucket4j-coherence">bucket4j-coherence</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, implementing the asynchronous support for any other JCache provider outside of the list above should be an easy exercise, so feel free to return back the pull request addressed to cover your favorite JCache provider.</p>
</div>
</div>
<div class="sect4">
<h5 id="verification-of-compatibility-with-a-particular-jcache-provider-is-your-responsibility"><a class="anchor" href="#verification-of-compatibility-with-a-particular-jcache-provider-is-your-responsibility"></a>Verification of compatibility with a particular JCache provider is your responsibility</h5>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Keep in mind that there are many non-certified implementations of JCache specifications on the market.
Many of them want to increase their popularity by declaring support for the JCache API,
but often only the API is supported and the semantic of JCache is totally ignored.
Usage Bucket4j with this kind of library should be completely avoided.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Bucket4j is only compatible with implementations that obey the JCache specification rules(especially related to EntryProcessor execution). Oracle Coherence, Apache Ignite, Hazelcast are good examples of safe implementations of JCache.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Because it is impossible to test all possible JCache providers, you need to test your provider by yourself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just run this code in order to be sure that your implementation of JCache provides good isolation for EntryProcessors</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.cache.Cache;
import javax.cache.processor.EntryProcessor;
import java.util.concurrent.CountDownLatch;
import java.io.Serializable;

public class CompatibilityTest {

    final Cache&lt;String, Integer&gt; cache;


    public CompatibilityTest(Cache&lt;String, Integer&gt; cache) {
        this.cache = cache;
    }

    public void test() throws InterruptedException {
        String key = "42";
        int threads = 4;
        int iterations = 1000;
        cache.put(key, 0);
        CountDownLatch latch = new CountDownLatch(threads);
        for (int i = 0; i &lt; threads; i++) {
            new Thread(() -&gt; {
                try {
                    for (int j = 0; j &lt; iterations; j++) {
                        EntryProcessor&lt;String, Integer, Void&gt; processor = (EntryProcessor&lt;String, Integer, Void&gt; &amp; Serializable) (mutableEntry, objects) -&gt; {
                            int value = mutableEntry.getValue();
                            mutableEntry.setValue(value + 1);
                            return null;
                        };
                        cache.invoke(key, processor);
                    }
                } finally {
                    latch.countDown();
                }
            }).start();
        }
        latch.await();
        int value = cache.get(key);
        if (value == threads * iterations) {
            System.out.println("Implementation which you use is compatible with Bucket4j");
        } else {
            String msg = "Implementation which you use is not compatible with Bucket4j";
            msg += ", " + (threads * iterations - value) + " writes are missed";
            throw new IllegalStateException(msg);
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The check does 4000 increments of integer in parallel and verifies that no one update has been missed.
If the check passed then your JCache provider is compatible with Bucket4j, the throttling will work fine in a distributed and concurrent environment. If the check is not passed, then reach out to the particular JCache provider team and consult why its implementation misses the writes.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-hazelcast"><a class="anchor" href="#bucket4j-hazelcast"></a>3.2.2. Hazelcast integration</h4>
<div class="sect4">
<h5 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h5>
<div class="paragraph">
<p>To use Bucket4j extension for Hazelcast with <code>Hazelcast 4.x</code> you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-hazelcast&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-hazelcast&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using a legacy version of Hazelcast <code>4.x</code> then you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-hazelcast-4&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-hazelcast-4&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="general-compatibility-matrix-principles"><a class="anchor" href="#general-compatibility-matrix-principles"></a>General compatibility matrix principles:</h5>
<div class="ulist">
<ul>
<li>
<p>Bucket4j authors do not perform continuous monitoring of new Hazelcast releases. So, there is can be a case when there is no one version of Bucket4j which is compatible with the newly released Hazelcast,
just log an issue to <a href="https://github.com/bucket4j/bucket4j/issues">bug tracker</a> in this case, adding support to new version of Hazelcast is usually an easy exercise.</p>
</li>
<li>
<p>Integrations with legacy versions of Hazelcast are not removed without a clear reason. Hence You are in safety, even you are working in a big enterprise company that does not update its infrastructure frequently because You still get new Bucket4j&#8217;s features even for legacy Hazelcast&#8217;s releases.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation"><a class="anchor" href="#example-of-bucket-instantiation"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">IMap&lt;K, byte[]&gt; map = ...;
private static final HazelcastProxyManager&lt;K&gt; proxyManager = Bucket4jHazelcast
    .entryProcessorBasedBuilder(map)
     // setup optional parameters if necessary
    .build();

...
BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();

Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-flexible-per-entry-expiration"><a class="anchor" href="#configuring-flexible-per-entry-expiration"></a>Configuring flexible per entry expiration</h5>
<div class="paragraph">
<p>It is possible configure precise expiration for bucket entries inside cache,
in order to avoid storing data related to buckets more than it needs to refill for consumed tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">IMap&lt;K, byte[]&gt; map = ...;
Duration evictionJitter = Duration.ofSeconds(15);
ExpirationAfterWriteStrategy expiration = ExpirationAfterWriteStrategy.basedOnTimeForRefillingBucketUpToMax(evictionJitter)

private static final HazelcastProxyManager&lt;K&gt; proxyManager = Bucket4jHazelcast
    .entryProcessorBasedBuilder(map)
    .expirationAfterWrite(expiration)
     // setup optional parameters if necessary
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>How to choose eviction jitter properly? Zero means immediate eviction after refill,
however it is better to avoid too small jitter, because recreation of bucket after expiration will require one network hope,
so it is better to configure at least of few seconds for jitter in order to avoid to frequent buckets recreation.</p>
</div>
</div>
<div class="sect4">
<h5 id="configuring-custom-serialization-for-bucket4j-library-classes"><a class="anchor" href="#configuring-custom-serialization-for-bucket4j-library-classes"></a>Configuring Custom Serialization for Bucket4j library classes</h5>
<div class="paragraph">
<p>If you configure nothing, then by default Java serialization will be used for serialization Bucket4j library classes. Java serialization can be rather slow and should be avoided in general.
<code>Bucket4j</code> provides <a href="https://docs.hazelcast.org/docs/3.0/manual/html/ch03s03.html">custom serializers</a> for all library classes that could be transferred over the network.</p>
</div>
<div class="paragraph">
<p>To let Hazelcast know about fast serializers you should register them programmatically in the serialization config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.hazelcast.config.Config;
import com.hazelcast.config.SerializationConfig;
import com.hazelcast.config.SerializerConfig;
import io.github.bucket4j.grid.hazelcast.serialization.HazelcastSerializer;
...
    Config config = ...
    SerializationConfig serializationConfig = config.getSerializationConfig();

    // the starting type ID number for Bucket4j classes.
    // you free to choose any unused ID, but be aware that Bucket4j uses 2 types currently,
    // and may use more types in the future, so leave enough empty space after baseTypeIdNumber
    int baseTypeIdNumber = 10000;

    HazelcastProxyManager.addCustomSerializers(serializationConfig, baseTypeIdNumber);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-custom-serialization-using-an-hazelcast-standalone-cluster"><a class="anchor" href="#configuring-custom-serialization-using-an-hazelcast-standalone-cluster"></a>Configuring Custom Serialization using an Hazelcast standalone cluster</h5>
<div class="paragraph">
<p>In case the Hazelcast Cluster is running as a standalone cluster outside your application, maybe started directly using its own jar or hosted by a third party software, you are not in position to register the custom serializers programmatically.</p>
</div>
<div class="paragraph">
<p>In order to let the hazelcast cluster be aware of the custom serialization the following 3 actions are required:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the Bucket4j jars (<code>bucket4j-core</code> and <code>bucket4j-hazelcast</code>) into the classpath of each node of the Hazelcast cluster</p>
</li>
<li>
<p>Declare the typeIdBase via <strong>OS Environment Variable</strong> or via <strong>Java System Property</strong>, in both case the name is: <code>bucket4j.hazelcast.serializer.type_id_base</code>. Of course the value provided here at the Hazelcast server side has to be the same used programmatically into your java code at hazelcast client side.</p>
</li>
<li>
<p>Configure the custom serializers into the Hazlecast server configuration file, see the following hazelcast config snippet as reference:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ----- Hazelcast SERIALIZATIONs configuration -----
serialization:
  serializers:
    - type-class: io.github.bucket4j.grid.hazelcast.HazelcastEntryProcessor
      class-name: io.github.bucket4j.grid.hazelcast.serialization.HazelcastEntryProcessorSerializer
    - type-class: io.github.bucket4j.grid.hazelcast.SimpleBackupProcessor
      class-name: io.github.bucket4j.grid.hazelcast.serialization.SimpleBackupProcessorSerializer
    - type-class: io.github.bucket4j.grid.hazelcast.HazelcastOffloadableEntryProcessor
      class-name: io.github.bucket4j.grid.hazelcast.serialization.HazelcastOffloadableEntryProcessorSerializer</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="support-for-externally-managed-hazelcast-without-classpath-access"><a class="anchor" href="#support-for-externally-managed-hazelcast-without-classpath-access"></a>Support for externally managed Hazelcast without classpath access</h5>
<div class="paragraph">
<p><code>bucket4j-hazelcast</code> requires putting Bucket4j jars to classpath of each node of Hazelcast cluster.
Sometimes you have no control over classpath because the Hazelcast cluster is externally managed(Paas scenario).
In such cases <code><code>HazelcastProxyManager</code></code> can not be used because it is implemented on top of <a href="https://docs.hazelcast.com/imdg/4.2/computing/entry-processor">EntryProcessor</a> functionality.</p>
</div>
<div class="dlist">
<div class="title">Bucket4j provides two alternatives for PaaS topology:</div>
<dl>
<dt class="hdlist1">HazelcastLockBasedProxyManager</dt>
<dd>
<p>is implemented on top IMap methods <code>lock</code>, <code>get</code>, <code>put</code>, <code>unlock</code>.
This implementation always requires 4 network hops for one rate-limit check.</p>
</dd>
<dt class="hdlist1">HazelcastCompareAndSwapBasedProxyManager</dt>
<dd>
<p>is implemented on top IMap methods <code>get</code>, <code>replace</code>, <code>putIfAbsent</code>.
This implementation requires 2 network hops if no contention happens, but in case of high contention on the key amount of hops is unpredictable.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Limitations of HazelcastLockBasedProxyManager and HazelcastCompareAndSwapBasedProxyManager</div>
<ul>
<li>
<p><code>HazelcastLockBasedProxyManager</code> does not provide async API because of lack of <code>lockAsync</code> and <code>unlockAsync</code>  methods inside IMap API.</p>
</li>
<li>
<p><code>HazelcastCompareAndSwapBasedProxyManager</code> does not provide async API because lack of <code>replaceAsync</code> and <code>putIfAbsentAsync</code> methods inside IMap API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you wish to async API be supported by <code>HazelcastLockBasedProxyManager</code> and <code>HazelcastCompareAndSwapBasedProxyManager</code> ask Hazelcast maintainers to support the missed APIs mentioned above.</p>
</div>
</div>
<div class="sect4">
<h5 id="known-issues-related-with-docker-andor-springboot"><a class="anchor" href="#known-issues-related-with-docker-andor-springboot"></a>Known issues related with Docker and(or) SpringBoot</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/bucket4j/bucket4j/discussions/186">#186 HazelcastEntryProcessor class not found</a> - check file permissions inside your image.</p>
</li>
<li>
<p><a href="https://github.com/bucket4j/bucket4j/issues/162">#182 HazelcastSerializationException with Hazelcast 4.2</a> - properly setup classloader for Hazelcast client configuration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-ignite"><a class="anchor" href="#bucket4j-ignite"></a>3.2.3. Apache Ignite integration</h4>
<div class="paragraph">
<p>Before use <code>bucket4j-ignite</code> module please read [bucket4j-jcache documentation](jcache-usage.md),
because <code>bucket4j-ignite</code> is just a follow-up of <code>bucket4j-jcache</code>.</p>
</div>
<div class="paragraph">
<p>Bucket4j supports Ignite Thin-Client as well as regular deployment scenarios.</p>
</div>
<div class="paragraph">
<p><strong>Question:</strong> Bucket4j already supports JCache since version <code>1.2</code>. Why it was needed to introduce direct support for <code>Apache Ignite</code>?
<strong>Answer:</strong> Because <a href="https://www.jcp.org/en/jsr/detail?id=107">JCache API (JSR 107)</a> does not specify asynchronous API,
developing the dedicated module <code>bucket4j-ignite</code> was the only way to provide asynchrony for users who use <code>Bucket4j</code> and <code>Apache Ignite</code> together.</p>
</div>
<div class="paragraph">
<p><strong>Question:</strong> Should I migrate from <code>bucket4j-jcache</code> to <code>bucketj-ignite</code> If I do not need an asynchronous API?
<strong>Answer:</strong> No, you should not migrate to <code>bucketj-ignite</code> in this case.</p>
</div>
<div class="sect4">
<h5 id="dependencies-2"><a class="anchor" href="#dependencies-2"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-ignite</code> extension you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-ignite&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-ignite&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-via-igniteproxymanager"><a class="anchor" href="#example-of-bucket-instantiation-via-igniteproxymanager"></a>Example of Bucket instantiation via IgniteProxyManager</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">org.apache.ignite.IgniteCache&lt;K, byte[]&gt; cache = ...;
private static final IgniteProxyManager proxyManager = Bucket4jIgnite.thickClient()
    .entryProcessorBasedBuilder(cache)
    // setup optional parameters if necessary
    .build();
...

BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();
Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Pay attention that IgniteProxyManager requires all nodes in the cluster to contain bucket4j Jars in classpath.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-via-thin-client"><a class="anchor" href="#example-of-bucket-instantiation-via-thin-client"></a>Example of Bucket instantiation via Thin Client</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">org.apache.ignite.client.ClientCache&lt;K, byte[]&gt; cache = ...;
org.apache.ignite.client.ClientCompute clientCompute = ...;
private static final IgniteThinClientProxyManager&lt;K&gt; proxyManager = Bucket4jIgnite.thinClient()
    .clientComputeBasedBuilder(cache, clientCompute)
    // setup optional parameters if necessary
    .build();
...

BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();
Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Pay attention that IgniteThinClientProxyManager requires all nodes in the cluster to contain bucket4j Jars in classpath.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-of-via-thin-client-and-ignitethinclientcasbasedproxymanager"><a class="anchor" href="#example-of-bucket-instantiation-of-via-thin-client-and-ignitethinclientcasbasedproxymanager"></a>Example of Bucket instantiation of via Thin Client and IgniteThinClientCasBasedProxyManager</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">org.apache.ignite.client.ClientCache&lt;K, byte[]&gt; cache = ...;
private static final IgniteThinClientCasBasedProxyManager&lt;K&gt; proxyManager = Bucket4jIgnite.thinClient()
    .casBasedBuilder(cache)
    // setup optional parameters if necessary
    .build();
...

BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();
Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
IgniteThinClientCasBasedProxyManager does not require all nodes in the cluster to contain bucket4j Jars in classpath, but it operates with more latency, so choose it over IgniteThinClientProxyManager if and only if you have no control over cluster classpath.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-infinispan"><a class="anchor" href="#bucket4j-infinispan"></a>3.2.4. Infinispan integration</h4>
<div class="sect4">
<h5 id="dependencies-3"><a class="anchor" href="#dependencies-3"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-infinispan</code> with <code>Infinispan 9.x, 10.x</code> extension you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-infinispan&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-infinispan&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using a legacy version of Infinispan <code>8.x</code> then you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-infinispan-8&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-infinispan-8&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="general-compatibility-matrix-principles-2"><a class="anchor" href="#general-compatibility-matrix-principles-2"></a>General compatibility matrix principles::</h5>
<div class="ulist">
<ul>
<li>
<p>Bucket4j authors do not perform continuous monitoring of new Infinispan releases. So, there is can be a case when there is no one version of Bucket4j which is compatible with the newly released Infinispan, just log an issue to <a href="https://github.com/bucket4j/bucket4j/issues">bug tracker</a> in this case, adding support to new version of Infinispan is usually an easy exercise.</p>
</li>
<li>
<p>Integrations with legacy versions of Infinispan are not removed without a clear reason. Hence, you are in safety, even you are working in a big enterprise company that does not update its infrastructure frequently because You still get new Bucket4j&#8217;s features even for legacy Infinispan&#8217;s releases.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="special-notes-for-infinispan-10-0"><a class="anchor" href="#special-notes-for-infinispan-10-0"></a>Special notes for Infinispan 10.0+</h5>
<div class="paragraph">
<p>As mentioned in the <a href="https://infinispan.org/docs/dev/titles/developing/developing.html#marshalling">Infinispan Marshalling documentation</a>, since release <code>10.0.0</code> Infinispan does not allow deserialization of custom payloads into Java classes. If you do not configure serialization(as described below), you will get an error like this on any attempt to use Bucket4j with a brand new Infinispan release:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Jan 02, 2020 4:57:56 PM org.infinispan.marshall.persistence.impl.PersistenceMarshallerImpl objectToBuffer
WARN: ISPN000559: Cannot marshall 'class io.github.bucket4j.grid.infinispan.InfinispanProcessor'
java.lang.IllegalArgumentException: No marshaller registered for Java type io.github.bucket4j.grid.infinispan.SerializableFunctionAdapter
   at org.infinispan.protostream.impl.SerializationContextImpl.getMarshallerDelegate(SerializationContextImpl.java:279)
   at org.infinispan.protostream.WrappedMessage.writeMessage(WrappedMessage.java:240)
   at org.infinispan.protostream.ProtobufUtil.toWrappedStream(ProtobufUtil.java:196)</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are three options to solve this problem:
* Configure Jboss marshaling instead of defaulting ProtoStream marshaller as described <a href="https://infinispan.org/docs/dev/titles/developing/developing.html#jboss_marshalling">there</a>.
* Configure Java Serialization Marshaller instead of default ProtoStream marshaller, as described <a href="https://infinispan.org/docs/dev/titles/developing/developing.html#java_serialization_marshaller">there</a>.
Do not forget to add <code>io.github.bucket4j.*</code> regexp to the whitelist if choosing this way.
* And last way(recommended) just register <code>Bucket4j serialization context initializer</code> in the serialization configuration.
You can do it in both programmatically and declarative ways:</p>
</div>
<div class="listingblock">
<div class="title">Programmatic registration of Bucket4jProtobufContextInitializer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.github.bucket4j.grid.infinispan.serialization.Bucket4jProtobufContextInitializer;
import org.infinispan.configuration.global.GlobalConfigurationBuilder;
...
GlobalConfigurationBuilder builder = new GlobalConfigurationBuilder();
builder.serialization().addContextInitializer(new Bucket4jProtobufContextInitializer());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Declarative registration of Bucket4jProtobufContextInitializer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;serialization&gt;
    &lt;context-initializer class="io.github.bucket4j.grid.infinispan.serialization.Bucket4jProtobufContextInitializer"/&gt;
&lt;/serialization&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that is all. Just registering <code>Bucket4jProtobufContextInitializer</code> in any way is enough to make Bucket4j compatible with ProtoStream marshaller, you do not have to care about <code>*.proto</code> files, annotations, whitelist, etc, all necessary Protobuffers configs generated by <code>Bucket4jProtobufContextInitializer</code> and register on the fly.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-2"><a class="anchor" href="#example-of-bucket-instantiation-2"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">org.infinispan.functional.FunctionalMap.ReadWriteMap&lt;K, byte[]&gt; map = ...;
private static final InfinispanProxyManager&lt;K&gt; proxyManager = Bucket4jInfinispan
    .entryProcessorBasedBuilder(cache)
     // setup optional parameters if necessary
    .build();
...
BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();

Bucket bucket = proxyManager.getProxy(key, configuration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-coherence"><a class="anchor" href="#bucket4j-coherence"></a>3.2.5. Oracle Coherence integration</h4>
<div class="sect4">
<h5 id="dependencies-4"><a class="anchor" href="#dependencies-4"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-coherence</code> extension you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-coherence&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-coherence&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-3"><a class="anchor" href="#example-of-bucket-instantiation-3"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">com.tangosol.net.NamedCache&lt;K, byte[]&gt; cache = ...;
private static final CoherenceProxyManager&lt;K&gt; proxyManager = Bucket4jCoherence
    .entryProcessorBasedBuilder(cache)
     // setup optional parameters if necessary
    .build();

...
BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();

Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-pof-serialization-for-bucket4j-library-classes"><a class="anchor" href="#configuring-pof-serialization-for-bucket4j-library-classes"></a>Configuring POF serialization for Bucket4j library classes</h5>
<div class="paragraph">
<p>If you configure nothing, then by default Java serialization will be used for serialization Bucket4j library classes. Java serialization can be rather slow and should be avoided in general.
<code>Bucket4j</code> provides <a href="https://docs.oracle.com/cd/E24290_01/coh.371/e22837/api_pof.htm#COHDG1363">custom POF serializers</a> for all library classes that could be transferred over the network.
To let Coherence know about POF serializers you should register three serializers in the POF configuration config file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><code>io.github.bucket4j.grid.coherence.pof.CoherenceEntryProcessorPofSerializer</code> for class <code>io.github.bucket4j.grid.coherence.CoherenceProcessor</code></p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example of POF serialization config:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;pof-config xmlns="http://xmlns.oracle.com/coherence/coherence-pof-config"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://xmlns.oracle.com/coherence/coherence-pof-config coherence-pof-config.xsd"&gt;

    &lt;user-type-list&gt;
        &lt;!-- Include default Coherence types --&gt;
        &lt;include&gt;coherence-pof-config.xml&lt;/include&gt;

        &lt;!-- Define serializers for Bucket4j classes --&gt;
        &lt;user-type&gt;
            &lt;type-id&gt;1001&lt;/type-id&gt;
            &lt;class-name&gt;io.github.bucket4j.grid.coherence.CoherenceProcessor&lt;/class-name&gt;
            &lt;serializer&gt;
                &lt;class-name&gt;io.github.bucket4j.grid.coherence.pof.CoherenceEntryProcessorPofSerializer&lt;/class-name&gt;
            &lt;/serializer&gt;
        &lt;/user-type&gt;
    &lt;/user-type-list&gt;
&lt;/pof-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Double-check with <a href="https://docs.oracle.com/cd/E24290_01/coh.371/e22837/api_pof.htm#COHDG5182">official Oracle Coherence documentation</a> in case of any questions related to <code>Portable Object Format</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bucket4j-redis"><a class="anchor" href="#bucket4j-redis"></a>3.3. Bucket4j-Redis</h3>
<div class="paragraph">
<p>Bucket4j provides integration with four Redis libraries:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Library</th>
<th class="tableblock halign-left valign-top">Async supported</th>
<th class="tableblock halign-left valign-top">Redis cluster supported</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Redisson</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Lettuce</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Jedis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For all libraries mentioned above concurrent access to Redis is solved by Compare&amp;Swap pattern, this can be improved in the future via switching to Javascript stored procedures.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="bucket4j-lettuce"><a class="anchor" href="#bucket4j-lettuce"></a>3.3.1. Lettuce integration</h4>
<div class="sect4">
<h5 id="dependencies-5"><a class="anchor" href="#dependencies-5"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-letucce</code> extension you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-redis-common&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-lettuce&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-redis-common&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-lettuce&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-via-lettucebasedproxymanager"><a class="anchor" href="#example-of-bucket-instantiation-via-lettucebasedproxymanager"></a>Example of Bucket instantiation via LettuceBasedProxyManager</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">StatefulRedisConnection&lt;K, byte[]&gt; connection = ...;
LettuceBasedProxyManager&lt;K&gt; proxyManager = Bucket4jLettuce.casBasedBuilder(connection)
    .expirationAfterWrite(ExpirationAfterWriteStrategy.basedOnTimeForRefillingBucketUpToMax(ofSeconds(10)))
    .build();
...

BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();
Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-redisson"><a class="anchor" href="#bucket4j-redisson"></a>3.3.2. Redisson integration</h4>
<div class="sect4">
<h5 id="dependencies-6"><a class="anchor" href="#dependencies-6"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-redisson</code> extension you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-redis-common&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-redisson&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-redis-common&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-redisson&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-via-redissonbasedproxymanager"><a class="anchor" href="#example-of-bucket-instantiation-via-redissonbasedproxymanager"></a>Example of Bucket instantiation via RedissonBasedProxyManager</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">RedissonBasedProxyManager&lt;String&gt; proxyManager = Bucket4jRedisson.casBasedBuilder(jedisPool)
    .expirationAfterWrite(ExpirationAfterWriteStrategy.basedOnTimeForRefillingBucketUpToMax(ofSeconds(10)))
    .keyMapper(Mapper.STRING)
    .build();
...

BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();
Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-jedis"><a class="anchor" href="#bucket4j-jedis"></a>3.3.3. Jedis integration</h4>
<div class="sect4">
<h5 id="dependencies-7"><a class="anchor" href="#dependencies-7"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-jedis</code> extension you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-redis-common&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-jedis&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-redis-common&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-jedis&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-via-jedisbasedproxymanager"><a class="anchor" href="#example-of-bucket-instantiation-via-jedisbasedproxymanager"></a>Example of Bucket instantiation via JedisBasedProxyManager</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">redis.clients.jedis.JedisPool jedisPool = ...;
JedisBasedProxyManager&lt;String&gt; proxyManager = Bucket4jJedis.casBasedBuilder(jedisPool)
    .expirationAfterWrite(ExpirationAfterWriteStrategy.basedOnTimeForRefillingBucketUpToMax(ofSeconds(10)))
    .keyMapper(Mapper.STRING)
    .build();
...

BucketConfiguration configuration = BucketConfiguration.builder()
    .addLimit(limit -&gt; capacity(1_000).refillGreedy(1_000, ofMinutes(1)))
    .build();
Bucket bucket = proxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-integrations"><a class="anchor" href="#jdbc-integrations"></a>3.4. JDBC integrations</h3>
<div class="paragraph">
<p>General principles to use each JDBC integration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bucket4j authors do not provide create a table for store buckets, you must make the table personally.
Examples of DDL provided for each integration.</p>
</li>
<li>
<p>You should create a trigger or a scheduler that will clear your bucket storage table since DBMS is not IMDB, and DBMS don&#8217;t give TTL the opportunity.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="overriding-table-and-columns-naming-scheme"><a class="anchor" href="#overriding-table-and-columns-naming-scheme"></a>3.4.1. Overriding table and columns naming scheme</h4>
<div class="ulist">
<div class="title">There is three naming parameters</div>
<ul>
<li>
<p><code>tableName</code> - name of table to use as a Buckets store. Default value is <code>bucket</code></p>
</li>
<li>
<p><code>idName</code> - name of primary key column. Default value is <code>id</code></p>
</li>
<li>
<p><code>stateName</code> - name of column to store state of bucket. Default value is <code>state</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can change naming as you wish, at proxy-manager build time. Bellow is example for Mysql,
the code for other integrations will be the same</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MySQLSelectForUpdateBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jMySQL
    .selectForUpdateBasedBuilder(dataSource)
    .table("user_buckets")
    .idColumn("user_id")
    .stateColumn("state_bytes")
    .build()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="overriding-type-of-primary-key"><a class="anchor" href="#overriding-type-of-primary-key"></a>3.4.2. Overriding type of primary key</h4>
<div class="paragraph">
<p>By default <code>java.lang.Long</code> is used as Java representation of value for primary-key column,
and it is expected that type of primary column must be assigned from Long during specifying parameters of <code>PreparedStatement</code>.<br></p>
</div>
<div class="paragraph">
<p>Sometimes you want to have to setting up something else for primary key column, for example <code>java.lang.String</code> and its correspondent type in database.
You can configure custom primary-key type at proxy-manager build time. Bellow is example for PostgreSQL,
the code for other integrations will be the same</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE IF NOT EXISTS bucket(id VARCHAR PRIMARY KEY, state BYTEA);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PostgreSQLSelectForUpdateBasedProxyManager&lt;String&gt; proxyManager = Bucket4jPostgreSQL
    .selectForUpdateBasedBuilder(dataSource)
    .primaryKeyMapper(PrimaryKeyMapper.STRING)
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several predefined mappers defined inside <code>io.github.bucket4j.distributed.jdbc.PrimaryKeyMapper</code>,
if nothing suitable then you can define own by implementing this interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-postgresql"><a class="anchor" href="#bucket4j-postgresql"></a>3.4.3. PostgreSQL integration</h4>
<div class="sect4">
<h5 id="dependencies-8"><a class="anchor" href="#dependencies-8"></a>Dependencies</h5>
<div class="paragraph">
<p>To use Bucket4j extension for PostgreSQL you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-postgresql&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-postgresql&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ddl-example"><a class="anchor" href="#ddl-example"></a>DDL example</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE IF NOT EXISTS bucket(id BIGINT PRIMARY KEY, state BYTEA);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="postgresqlselectforupdatebasedproxymanager"><a class="anchor" href="#postgresqlselectforupdatebasedproxymanager"></a>PostgreSQLSelectForUpdateBasedProxyManager</h5>
<div class="paragraph">
<p><code>PostgreSQLSelectForUpdateBasedProxyManager</code> - is based on Select For Update standard SQL Syntax.
This prevents them from being modified or deleted by other transactions until the current transaction ends.
That is, other transactions that attempt UPDATE, DELETE, or SELECT FOR UPDATE of these rows will be blocked until the current transaction ends.
Also, if an UPDATE, DELETE, or SELECT FOR UPDATE from another transaction has already locked a selected row or rows, SELECT FOR UPDATE will wait for the other transaction to complete, and will then lock and return the updated row (or no row, if the row was deleted).
Within a SERIALIZABLE transaction, however, an error will be thrown if a row to be locked has changed since the transaction started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PostgreSQLadvisoryLockBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jPostgreSQL
    .selectForUpdateBasedBuilder(dataSource)
    .build();
...
Long key = 1L;
BucketConfiguration bucketConfiguration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
    .build();
BucketProxy bucket = proxyManager.getProxy(key, () -&gt; bucketConfiguration);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="postgresqladvisorylockbasedproxymanager"><a class="anchor" href="#postgresqladvisorylockbasedproxymanager"></a>PostgreSQLadvisoryLockBasedProxyManager</h5>
<div class="paragraph">
<p><code>PostgreSQLadvisoryLockBasedProxyManager</code> - is based on pg_advisory_xact_lock locks an application-defined resource, which can be identified either by a single 64-bit key value or two 32-bit key values (note that these two key spaces do not overlap).
If another session already holds a lock on the same resource identifier, this function will wait until the resource becomes available.
The lock is exclusive.
Multiple lock requests stack so that if the same resource is locked three times it must then be unlocked three times to be released for other sessions use.
The lock is automatically released at the end of the current transaction and cannot be released explicitly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PostgreSQLadvisoryLockBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jPostgreSQL
    .advisoryLockBasedBuilder(dataSource)
    .build();
...
Long key = 1L;
BucketConfiguration bucketConfiguration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
    .build();
BucketProxy bucket = proxyManager.getProxy(key, () -&gt; bucketConfiguration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-mysql"><a class="anchor" href="#bucket4j-mysql"></a>3.4.4. MySQL integration</h4>
<div class="sect4">
<h5 id="dependencies-9"><a class="anchor" href="#dependencies-9"></a>Dependencies</h5>
<div class="paragraph">
<p>To use <code>bucket4j-coherence</code> extension you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-coherence&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-coherence&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ddl-example-2"><a class="anchor" href="#ddl-example-2"></a>DDL example</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE IF NOT EXISTS bucket(id BIGINT PRIMARY KEY, state BLOB);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-4"><a class="anchor" href="#example-of-bucket-instantiation-4"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MySQLSelectForUpdateBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jMySQL
    .selectForUpdateBasedBuilder(dataSource)
    .build();

...
Long key = 1L;
BucketConfiguration bucketConfiguration = BucketConfiguration.builder()
        .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
        .build();
BucketProxy bucket = proxyManager.getProxy(key, () -&gt; bucketConfiguration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-mariadb"><a class="anchor" href="#bucket4j-mariadb"></a>3.4.5. MariaDB integration</h4>
<div class="sect4">
<h5 id="dependencies-10"><a class="anchor" href="#dependencies-10"></a>Dependencies</h5>
<div class="paragraph">
<p>To use Bucket4j extension for MariaDB you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-mariadb&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-mariadb&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ddl-example-3"><a class="anchor" href="#ddl-example-3"></a>DDL example</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE IF NOT EXISTS bucket(id BIGINT PRIMARY KEY, state BLOB);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-5"><a class="anchor" href="#example-of-bucket-instantiation-5"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MariaDBSelectForUpdateBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jMariaDB
    .selectForUpdateBasedBuilder(dataSource)
    .build();

...
Long key = 1L;
BucketConfiguration bucketConfiguration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
    .build();
BucketProxy bucket = proxyManager.getProxy(key, () -&gt; bucketConfiguration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-oracle"><a class="anchor" href="#bucket4j-oracle"></a>3.4.6. Oracle database integration</h4>
<div class="sect4">
<h5 id="dependencies-11"><a class="anchor" href="#dependencies-11"></a>Dependencies</h5>
<div class="paragraph">
<p>To use Bucket4j extension for Oracle you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-oracle&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-oracle&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ddl-example-4"><a class="anchor" href="#ddl-example-4"></a>DDL example</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE bucket(id NUMBER NOT NULL PRIMARY KEY, state RAW(255));</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-6"><a class="anchor" href="#example-of-bucket-instantiation-6"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OracleSelectForUpdateBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jOracle
    .selectForUpdateBasedBuilder(dataSource)
    .build();
...
Long key = 1L;
BucketConfiguration bucketConfiguration = BucketConfiguration.builder()
    .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
    .build();
BucketProxy bucket = proxyManager.getProxy(key, () -&gt; bucketConfiguration);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bucket4j-mssql"><a class="anchor" href="#bucket4j-mssql"></a>3.4.7. MicrosoftSQLServer integration</h4>
<div class="sect4">
<h5 id="dependencies-12"><a class="anchor" href="#dependencies-12"></a>Dependencies</h5>
<div class="paragraph">
<p>To use Bucket4j extension for Microsoft SQL Server you need to add following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- For java 17 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk17-mssql&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- For java 11 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bucket4j&lt;/groupId&gt;
    &lt;artifactId&gt;bucket4j_jdk11-mssql&lt;/artifactId&gt;
    &lt;version&gt;8.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ddl-example-5"><a class="anchor" href="#ddl-example-5"></a>DDL example</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE bucket(id INT NOT NULL PRIMARY KEY, state BINARY(256))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-of-bucket-instantiation-7"><a class="anchor" href="#example-of-bucket-instantiation-7"></a>Example of Bucket instantiation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MSSQLSelectForUpdateBasedProxyManager&lt;Long&gt; proxyManager = Bucket4jMSSQL
    .selectForUpdateBasedBuilder(dataSource)
    .build();
...
BucketConfiguration bucketConfiguration = BucketConfiguration.builder()
        .addLimit(limit -&gt; limit.capacity(10).refillGreedy(10, ofSeconds(1)))
        .build();
BucketProxy bucket = proxyManager.getProxy(key, () -&gt; bucketConfiguration);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="distributed-facilities-advanced-topics"><a class="anchor" href="#distributed-facilities-advanced-topics"></a>4. Distributed facilities advanced topics</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="asynchronous-api"><a class="anchor" href="#asynchronous-api"></a>4.1. Asynchronous API</h3>
<div class="paragraph">
<p>Since version <code>3.0</code> Bucket4j provides asynchronous analogs for the majority of API methods.
Async view of proxyManager is available through <code>asAsync()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ProxyManager proxyManager = ...;
AsyncProxyManager asyncProxyManager = proxyManager.asAsync();

BucketConfiguration configuration = ...;
AsyncBucketProxy asyncBucket = asyncProxyManager.getProxy(key, () -&gt; configuration);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each method of class <code><code>AsyncBucketProxy</code></code> has full equivalence with the same semantic in asynchronous version in the <code><code>Bucket</code></code> class.</p>
</div>
<div class="sect3">
<h4 id="example-limiting-the-rate-of-access-to-the-asynchronous-servlet"><a class="anchor" href="#example-limiting-the-rate-of-access-to-the-asynchronous-servlet"></a>4.1.1. Example - limiting the rate of access to the asynchronous servlet</h4>
<div class="paragraph">
<p>Imagine that you develop an SMS service, which allows sending SMS via an HTTP interface.
You want your architecture to be protected from overloading, clustered, and fully asynchronous.</p>
</div>
<div class="paragraph">
<p><strong>Overloading protection requirement:</strong></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>To prevent fraud and service overloading you want to introduce the following limit for any outbound phone number: The bucket size is 20 SMS (which cannot be exceeded at any given time), with a "refill rate" of 10 SMS per minute that continually increases tokens in the bucket.
In other words, if a client sends 10 SMS per minute, it will never be throttled,
and moreover, the client has overdraft equals to 20 SMS which can be used if the average is a little bit higher than 10 SMS/minute on short time period.
<strong>Solution:</strong> let&#8217;s use bucket4j for this.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Clustering requirement:</strong></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>You want to avoid the single point of failure, if one server crashed that information about consumed tokens should not be lost,
thus it would be better to use any distributed computation platform for storing the buckets.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Solution:</strong> let&#8217;s use JBoss Infinispan for this and <code>bucket4j-infinispan</code> extension.
Hazelcast and Apache Ignite will be also well-chosen, Infinispan just selected as an example.</p>
</div>
<div class="paragraph">
<p><strong>Asynchronous processing requirement:</strong>
Also for maximum scalability, you want from architecture to be fully non-blocking,
non-blocking architecture means that both sms sending and limit checking should be asynchronous.
<strong>Solution:</strong> let&#8217;s use asynchronous features provided by bucket4j and Servlet-API.</p>
</div>
<div class="paragraph">
<p><strong>Mockup of service based on top of Servlet API and bucket4j-infinispan</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SmsServlet extends javax.servlet.http.HttpServlet {

    private SmsSender smsSender;
    private AsyncProxyManager&lt;String&gt; buckets;
    private Supplier&lt;BucketConfiguration&gt; configurationSupplier;

    @Override
    public void init(ServletConfig config) throws ServletException {
        super.init(config);
        ServletContext ctx = config.getServletContext();

        smsSender = (SmsSender) ctx.getAttribute("sms-sender");

        FunctionalMapImpl&lt;String, byte[]&gt; bucketMap = (FunctionalMapImpl&lt;String, byte[]&gt;) ctx.getAttribute("bucket-map");
        this.buckets = new InfinispanProxyManager(bucketMap).asAsync();

        this.configurationSupplier = () -&gt; {
            return BucketConfiguratiion.builder()
                .addLimit(limit -&gt; limit.capacity(20).refillGreedy(10, Duration.ofMinutes(1)))
                .build();
        };
    }

    @Override
    protected void doPost(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;

        String fromNumber = req.getParameter("from");
        String toNumber = req.getParameter("to");
        String text = req.getParameter("text");

        AsyncBucketProxy bucket = buckets.getProxy(fromNumber, configurationSupplier);
        CompletableFuture&lt;ConsumptionProbe&gt; limitCheckingFuture = bucket.asAsync().tryConsumeAndReturnRemaining(1);
        final AsyncContext asyncContext = req.startAsync();
        limitCheckingFuture.thenCompose(probe -&gt; {
            if (!probe.isConsumed()) {
                Result throttledResult = Result.throttled(probe);
                return CompletableFuture.completedFuture(throttledResult);
            } else {
                CompletableFuture&lt;Result&gt; sendingFuture = smsSender.sendAsync(fromNumber, toNumber, text);
                return sendingFuture;
            }
        }).whenComplete((result, exception) -&gt; {
            HttpServletResponse asyncResponse = (HttpServletResponse) asyncContext.getResponse();
            try {
                asyncResponse.setContentType("text/plain");
                if (exception != null || result.isFailed()) {
                    asyncResponse.setStatus(500);
                    asyncResponse.getWriter().println("Internal Error");
                } else if (result.isThrottled()) {
                    asyncResponse.setStatus(429);
                    asyncResponse.setHeader("X-Rate-Limit-Retry-After-Seconds", "" + result.getRetryAfter());
                    asyncResponse.getWriter().append("Too many requests");
                } else {
                    asyncResponse.setStatus(200);
                    asyncResponse.getWriter().append("Success");
                }
            } finally{
                asyncContext.complete();
            }
        });
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implicit-configuration-replacement"><a class="anchor" href="#implicit-configuration-replacement"></a>4.2. Implicit configuration replacement</h3>
<div class="paragraph">
<div class="title">How does explicit configuration replacement work for case of distributed buckets:</div>
<p>distributed bucket operates with configuration that was provided at the time of its creation. Providing the new configuration via RemoteBucketBuilder takes no effect if bucket already exists in the persistent storage, because configuration is stored together with state of bucket. There is only one way to replace configuration of bucket - is explicit calling of replaceConfiguration(or its async analog).</p>
</div>
<div class="ulist">
<div class="title">Explicit config replacement can be awkward in the following cases:</div>
<ul>
<li>
<p>It requires for library client to write the code for configuration replacement. It is unnecessary job, that is especially hard when bucket4j is used behind of high-level frameworks like bucket4j-spring-boot-starter, when end-clients are not mentally prepared to work directly with low-level API of Bucket4j.</p>
</li>
<li>
<p>It can confuse the user in the following scenario: user stores limits in the configuration for example in properties or yaml file, user updates configuration files and restarts application and he becomes surprised because new limits are not applied for buckets that survive application restart in the storage, because as was mentioned above only one way to change the config for already persisted bucket is explicitly calling of replaceConfiguration for each persisted bucket.</p>
</li>
<li>
<p>For some persistent technologies like Redis it is costly to identify all buckets that are persisted in the storage, because lack of mechanisms for grouping like tables or caches leads to scan all keys, even keys that points to data that not related to rate-limiting.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Implicit configuration replacement solution:</div>
<p><code>Implicit configuration replacement feature</code> is addressed to solve the awkwards described above. It works based on configuration version,
when bucket detects that persisted configuration version is less that provided through builder API then persisted configuration is being replaced automatically without disturbing the client. Both <code>RemoteBucketBuilder</code> and <code>RemoteAsyncBucketBuilder</code> contains the API to configure desired configuration version.</p>
</div>
<div class="listingblock">
<div class="title">Example of usage</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BucketConfiguration config = ...;
BucketProxy bucket = proxyManager.builder()
    .withImplicitConfigurationReplacement(1, TokensInheritanceStrategy.PROPORTIONALLY)
    .build(666L, config);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="framework-to-implement-custom-work-with-your-database"><a class="anchor" href="#framework-to-implement-custom-work-with-your-database"></a>4.3. Framework to implement custom work with your database</h3>
<div class="paragraph">
<p>The Bucket4j library allows implementing work with any database.
If you didn&#8217;t find in distributed realization your database (currently Bucket4j supports the next databases: Redis, Hazelcast, Apache Ignite, Infinispan, Oracle coherence, PostgreSQL, MySQL)
you can implement your database as a distributed storage.
All what you need to do, extends from io.github.bucket4j.distributed.proxy.generic.select_for_update.AbstractLockBasedProxyManager or
AbstractSelectForUpdateBasedProxyManager&lt;T&gt;
and override 3 methods and create your implementation which implements from io.github.bucket4j.distributed.proxy.generic.select_for_update.LockBasedTransaction.</p>
</div>
<div class="paragraph">
<p><strong>Step by step to take that.</strong></p>
</div>
<div class="paragraph">
<p><strong>First of all</strong>
we need to create our custom proxy manages which extends from AbstractLockBasedProxyManager&lt;T&gt; or AbstractSelectForUpdateBasedProxyManager&lt;T&gt; (as genetic classes takes a type of key table).
To define in which class you should extend, need to understand the main idea of these classes:</p>
</div>
<div class="paragraph">
<p><code>AbstractLockBasedProxyManager&lt;T&gt;</code> - Uses to realize based on exclusive locks</p>
</div>
<div class="paragraph">
<p><code>AbstractSelectForUpdateBasedProxyManager&lt;T&gt;</code> - Uses to realize Select For Update concept</p>
</div>
<div class="paragraph">
<p>After need to override works of allocation transaction, to do that, we should override method allocateTransaction.
The main idea of allocateTransaction to just return class which implements <code>LockBasedTransaction</code> (for <code>AbstractLockBasedProxyManager&lt;T&gt;</code>)
or <code>SelectForUpdateBasedTransaction</code> (for <code>AbstractSelectForUpdateBasedProxyManager&lt;T&gt;</code>) - we will implement it later
And override removeProxy() for remove bucket from the table which store buckets.</p>
</div>
<div class="paragraph">
<p><strong>Second of all</strong></p>
</div>
<div class="paragraph">
<p>Need to implement <code>LockBasedTransaction</code> or <code>SelectForUpdateBasedTransaction</code> to realize custom work of database for transaction.</p>
</div>
<div class="paragraph">
<p>To do that, we need to create a custom class to implement from one of these classes</p>
</div>
<div class="paragraph">
<p><strong>LockBasedTransaction</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    /**
     * Begins transaction if underlying storage requires transactions.
     * There is strong guarantee that {@link #commit()} or {@link #rollback()} will be called if {@link #begin()} returns successfully.
     */
    void begin();

    /**
     * Rollbacks transaction if underlying storage requires transactions
     */
    void rollback();

    /**
     * Commits transaction if underlying storage requires transactions
     */
    void commit();

    /**
     * Locks data by the key associated with this transaction and returns data that is associated with the key.
     * There is strong guarantee that {@link #unlock()} will be called if {@link #lockAndGet()} returns successfully.
     *
     * @return Returns the data by the key associated with this transaction, or null data associated with key does not exist
     */
    byte[] lockAndGet();

    /**
     * Unlocks data by the key associated with this transaction.
     */
    void unlock();

    /**
     * Creates the data by the key associated with this transaction.
     *
     * @param data bucket state to persists
     */
    void create(byte[] data);

    /**
     * Updates the data by the key associated with this transaction.
     *
     * @param data bucket state to persists
     */
    void update(byte[] data);

    /**
     * Frees resources associated with this transaction
     */
    void release();</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example, you can see to the PostgreSQL or MySQL realization which based on select for update concept.</p>
</div>
<div class="paragraph">
<p><strong>SelectForUpdateBasedTransaction</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    /**
     * Begins transaction if underlying storage requires transactions.
     * There is strong guarantee that {@link #commit()} or {@link #rollback()} will be called if {@link #begin()} returns successfully.
     */
    void begin();

    /**
     * Rollbacks transaction if underlying storage requires transactions
     */
    void rollback();

    /**
     * Commits transaction if underlying storage requires transactions
     */
    void commit();

    /**
     * Locks data by the key associated with this transaction and returns data that is associated with the key.
     *
     * @return the data by the key associated with this transaction, or null data associated with key does not exist
     */
    LockAndGetResult tryLockAndGet();

    /**
     * Creates empty data by for the key associated with this transaction.
     * This operation is required to be able to lock data in the scope of next transaction.
     *
     * @return true if data has been inserted
     */
    boolean tryInsertEmptyData();

    /**
     * Updates the data by the key associated with this transaction.
     *
     * @param data bucket state to persists
     */
    void update(byte[] data);

    /**
     * Frees resources associated with this transaction
     */
    void release();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 8.11.0<br>
Last updated 2023-10-25 19:01:02 +0300
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>